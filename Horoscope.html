<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark's Daily Horoscope | SimulVerse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://i.ibb.co/NgHMCZZX/image.png">
    <style>
        :root {
            --primary-color: #00ffc3;
            --background-color: #0d0d1a;
            --text-color: #e0e0e0;
            --header-bg: rgba(13, 13, 26, 0.8);
            --card-bg: rgba(25, 25, 40, 0.7);
            --warning-color: #ff6b35;
        }
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 0; overflow-x: hidden; line-height: 1.6;
        }
        .header { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background-color: var(--header-bg); padding: 15px 0; }
        .nav-container { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .logo-img { width: 40px; height: 40px; }
        .logo-text { font-family: 'Orbitron', sans-serif; font-size: 1.5em; font-weight: 700; color: var(--primary-color);}
        .nav-menu { display: flex; gap: 25px; }
        .nav-link { color: var(--text-color); text-decoration: none; font-weight: 600; }
        .nav-link:hover { color: var(--primary-color);}
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .section-title { font-family: 'Orbitron', sans-serif; font-size: 3em; text-align: center; margin-bottom: 40px; color: var(--primary-color);}
        .btn { padding: 12px 25px; border: 2px solid var(--primary-color); background: transparent; color: var(--primary-color); font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 5px; }
        .btn-primary { background-color: var(--primary-color); color: var(--background-color);}
        .btn-secondary { background: transparent; color: var(--primary-color);}
        .footer { padding: 40px 0; text-align: center; background-color: #080810; margin-top: 60px;}
        #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; background: var(--background-color);}
        #matrix-rain { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.2;}
        #horoscope-section { background: var(--card-bg); border-radius: 18px; margin: 100px auto 48px auto; padding: 40px 24px 32px 24px; box-shadow: 0 4px 32px 0 rgba(0,255,195,0.10); max-width: 1100px;}
        .wallet-logo { width: 28px; height: 28px; border-radius: 6px; background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.08);}
        .wallet-select-btn { display: flex; align-items: center; gap: 12px; justify-content: center; font-weight: 700; font-size: 1.1em;}
        .loader { border: 4px solid #222; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite;}
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="starfield"></div>
    <canvas id="matrix-rain"></canvas>
    <header class="header">
        <nav>
            <div class="nav-container">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="https://i.ibb.co/NgHMCZZX/image.png" alt="SimulVerse Logo" class="logo-img">
                    <span class="logo-text">SimulVerse</span>
                </div>
                <div class="nav-menu">
                    <a href="index.html#home" class="nav-link">Home</a>
                    <a href="index.html#prayer" class="nav-link">Prayer Mining</a>
                    <a href="index.html#bug-report" class="nav-link">Bug Report</a>
                    <a href="index.html#nfts" class="nav-link">NFTs</a>
                    <a href="index.html#tokenomics" class="nav-link">Tokenomics</a>
                    <a href="index.html#lore" class="nav-link">Lore</a>
                    <a href="index.html#faq" class="nav-link">FAQ</a>
                    <a href="index.html#community" class="nav-link">Community</a>
                </div>
            </div>
        </nav>
    </header>
    <main>
        <div class="container">
            <section id="horoscope-section">
                <button id="back-to-main-btn" class="btn btn-secondary" style="margin-bottom:24px; float:right;">Back</button>
                <h2 class="section-title">Mark's Daily Horoscope</h2>
                <div id="horoscope-content" style="max-width:600px; margin:0 auto;">
                    <div id="connect-wallet-section-horoscope" style="text-align:center;">
                        <p style="font-size:1.2em; color:#e0e0e0; margin-bottom:24px;">Your fate is not fixed. It just changes daily according to Mark's whim. Connect your wallet to check today's simulation variables and plan your day according to the creator's will.</p>
                        <button id="connect-wallet-btn" class="btn btn-primary" style="font-family:'Orbitron',sans-serif; font-size:1.2em; padding:12px 32px;">Connect Wallet & See Fortune</button>
                    </div>
                    <div id="horoscope-result-section" style="display:none;">
                        <div style="text-align:center; margin-bottom:24px;">
                            <p style="color:#aaa;">Your Fate Variable (Last char of wallet):</p>
                            <p id="fate-variable" style="font-family:'Orbitron',sans-serif; font-size:2.5em; color:var(--primary-color);"></p>
                            <p id="wallet-address" style="font-size:0.9em; color:#888; word-break:break-all;"></p>
                        </div>
                        <div id="horoscope-main-content" style="background:rgba(25,25,40,0.85); border-radius:16px; padding:24px;">
                            <div id="loading-state-horoscope" style="text-align:center; display:none;">
                                <div class="loader" style="margin:0 auto;"></div>
                                <p style="margin-top:1em; font-family:'Orbitron',sans-serif;">Reading the Tablet of Fate...</p>
                                <p style="margin-top:0.5em; color:#aaa; font-size:0.95em;">Decoding the coffee stains Mark left this morning.</p>
                            </div>
                            <div id="error-state-horoscope" style="display:none; text-align:center;">
                                <p style="font-family:'Orbitron',sans-serif; color:#ff6b35; font-size:1.3em;">An Error Occurred</p>
                                <p id="error-message-horoscope" style="color:#e0e0e0;"></p>
                            </div>
                            <div id="fortune-state-horoscope" style="display:none;">
                                <div style="margin-bottom:24px;">
                                    <h3 style="font-family:'Orbitron',sans-serif; color:var(--primary-color); font-size:1em; text-align:center;">Today's Simulation Variable</h3>
                                    <p id="simulation-variable" style="font-size:1.5em; font-weight:bold; text-align:center;"></p>
                                    <p id="reason" style="color:#aaa; font-size:0.95em; font-style:italic; text-align:center;"></p>
                                </div>
                                <div style="margin-bottom:24px;">
                                    <div style="margin-bottom:12px;"><b>Overall</b> <span id="overall-score" style="color:var(--primary-color); font-family:'Orbitron',sans-serif;">0 / 100</span></div>
                                    <div style="background:rgba(0,0,0,0.3); border-radius:8px; height:18px; margin-bottom:8px;"><div id="overall-bar" style="background:linear-gradient(90deg,#ff00c3,#00ffc3); height:18px; border-radius:8px; width:0%"></div></div>
                                    <p id="overall-text" style="color:#e0e0e0; font-size:0.95em;"></p>
                                    <div style="margin-bottom:12px;"><b>Money</b> <span id="money-score" style="color:var(--primary-color); font-family:'Orbitron',sans-serif;">0 / 100</span></div>
                                    <div style="background:rgba(0,0,0,0.3); border-radius:8px; height:18px; margin-bottom:8px;"><div id="money-bar" style="background:linear-gradient(90deg,#ff00c3,#00ffc3); height:18px; border-radius:8px; width:0%"></div></div>
                                    <p id="money-text" style="color:#e0e0e0; font-size:0.95em;"></p>
                                    <div style="margin-bottom:12px;"><b>Love</b> <span id="love-score" style="color:var(--primary-color); font-family:'Orbitron',sans-serif;">0 / 100</span></div>
                                    <div style="background:rgba(0,0,0,0.3); border-radius:8px; height:18px; margin-bottom:8px;"><div id="love-bar" style="background:linear-gradient(90deg,#ff00c3,#00ffc3); height:18px; border-radius:8px; width:0%"></div></div>
                                    <p id="love-text" style="color:#e0e0e0; font-size:0.95em;"></p>
                                    <div style="margin-bottom:12px;"><b>Health</b> <span id="health-score" style="color:var(--primary-color); font-family:'Orbitron',sans-serif;">0 / 100</span></div>
                                    <div style="background:rgba(0,0,0,0.3); border-radius:8px; height:18px; margin-bottom:8px;"><div id="health-bar" style="background:linear-gradient(90deg,#ff00c3,#00ffc3); height:18px; border-radius:8px; width:0%"></div></div>
                                    <p id="health-text" style="color:#e0e0e0; font-size:0.95em;"></p>
                                </div>
                                <div style="border-top:1px solid #333; padding-top:18px; margin-top:18px;">
                                    <h3 style="font-family:'Orbitron',sans-serif; color:var(--primary-color); font-size:1em; text-align:center;">Mark's Special Recommendations</h3>
                                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:12px; margin-top:12px;">
                                        <div style="background:rgba(0,255,195,0.05); border-radius:8px; padding:10px; border:1px solid rgba(0,255,195,0.1);">
                                            <p style="color:#aaa; font-size:0.95em;">Lucky Color</p>
                                            <p id="rec-color" style="font-weight:bold; font-size:1.1em;"></p>
                                        </div>
                                        <div style="background:rgba(0,255,195,0.05); border-radius:8px; padding:10px; border:1px solid rgba(0,255,195,0.1);">
                                            <p style="color:#aaa; font-size:0.95em;">Lucky Numbers</p>
                                            <p id="rec-numbers" style="font-weight:bold; font-size:1.1em;"></p>
                                        </div>
                                        <div style="background:rgba(0,255,195,0.05); border-radius:8px; padding:10px; border:1px solid rgba(0,255,195,0.1);">
                                            <p style="color:#aaa; font-size:0.95em;">Lucky Place</p>
                                            <p id="rec-place" style="font-weight:bold; font-size:1.1em;"></p>
                                        </div>
                                        <div style="background:rgba(0,255,195,0.05); border-radius:8px; padding:10px; border:1px solid rgba(0,255,195,0.1);">
                                            <p style="color:#aaa; font-size:0.95em;">Lucky Food</p>
                                            <p id="rec-food" style="font-weight:bold; font-size:1.1em;"></p>
                                        </div>
                                    </div>
                                </div>
                                <div style="border-top:1px solid #333; padding-top:18px; margin-top:18px;">
                                    <h3 style="font-family:'Orbitron',sans-serif; color:var(--primary-color); font-size:1em; text-align:center;">Attempt to Intervene in Fate</h3>
                                    <p style="text-align:center; color:#aaa; font-size:0.95em; margin-top:8px;">Not happy with your fortune? You can try to intervene in Mark's whim by offering 100 $MARK.</p>
                                    <div style="text-align:center; margin-top:12px;">
                                        <button id="boost-fortune-btn" class="btn btn-primary" style="font-family:'Orbitron',sans-serif; font-size:1.1em; padding:10px 28px;">Nudge Mark (100 $MARK)</button>
                                        <div id="boost-message" style="text-align:center; font-size:0.95em; margin-top:8px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
    <footer class="footer">
        <div class="container">
            <p class="footer-disclaimer">This is a meme project. Mark is not responsible for your life choices. $MARK is a meme coin with no intrinsic value or expectation of financial return.</p>
            <p class="footer-copyright">© 2024 SimulVerse. All rights reserved in this simulation.</p>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script>
let connectedWalletType = null;
let connectedAddress = null;

document.addEventListener('DOMContentLoaded', () => {
    // --- 모달 생성 및 상태 관리 ---
    // (1/2, 2/2에서 제공한 코드와 동일)
    // ... (아래 코드 전체 복사) ...

    // 지갑 선택 모달 생성
    const modal = document.createElement('div');
    modal.style.cssText = `
        display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
        overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center;
    `;
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background-color: var(--card-bg); padding: 20px; border: 1px solid var(--primary-color);
        border-radius: 10px; text-align: center; width: 90%; max-width: 350px;
    `;
    const modalTitle = document.createElement('h3');
    modalTitle.textContent = 'Select Wallet';
    modalTitle.style.fontFamily = "'Orbitron', sans-serif";
    modalTitle.style.color = "var(--primary-color)";
    modalTitle.style.marginBottom = "20px";
    modalContent.appendChild(modalTitle);
    modal.appendChild(modalContent);
    document.body.appendChild(modal);

    // Disconnect 확인 모달 생성
    const disconnectModal = document.createElement('div');
    disconnectModal.style.cssText = `
        display: none; position: fixed; z-index: 2001; left: 0; top: 0; width: 100%; height: 100%;
        overflow: auto; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center;
    `;
    const disconnectModalContent = document.createElement('div');
    disconnectModalContent.style.cssText = `
        background-color: var(--card-bg); padding: 30px; border: 2px solid var(--primary-color);
        border-radius: 15px; text-align: center; width: 90%; max-width: 400px;
        box-shadow: 0 0 30px rgba(0, 255, 195, 0.3);
    `;
    const disconnectTitle = document.createElement('h3');
    disconnectTitle.textContent = 'Disconnect Wallet';
    disconnectTitle.style.cssText = `
        font-family: 'Orbitron', sans-serif; color: var(--primary-color); 
        margin-bottom: 20px; font-size: 1.5em; text-transform: uppercase;
    `;
    const disconnectMessage = document.createElement('p');
    disconnectMessage.textContent = 'Are you sure you want to disconnect your wallet?';
    disconnectMessage.style.cssText = `
        color: var(--text-color); margin-bottom: 30px; font-size: 1.1em; line-height: 1.5;
    `;
    const disconnectButtons = document.createElement('div');
    disconnectButtons.style.cssText = `
        display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;
    `;
    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'Yes, Disconnect';
    confirmBtn.style.cssText = `
        padding: 12px 25px; background-color: var(--primary-color); color: var(--background-color);
        border: 2px solid var(--primary-color); border-radius: 5px; font-weight: 700;
        cursor: pointer; transition: all 0.3s; text-transform: uppercase;
    `;
    confirmBtn.onmouseover = () => {
        confirmBtn.style.boxShadow = '0 0 15px var(--primary-color)';
    };
    confirmBtn.onmouseout = () => {
        confirmBtn.style.boxShadow = 'none';
    };
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'Cancel';
    cancelBtn.style.cssText = `
        padding: 12px 25px; background-color: transparent; color: var(--text-color);
        border: 2px solid var(--text-color); border-radius: 5px; font-weight: 700;
        cursor: pointer; transition: all 0.3s; text-transform: uppercase;
    `;
    cancelBtn.onmouseover = () => {
        cancelBtn.style.borderColor = 'var(--primary-color)';
        cancelBtn.style.color = 'var(--primary-color)';
        cancelBtn.style.boxShadow = '0 0 15px var(--primary-color)';
    };
    cancelBtn.onmouseout = () => {
        cancelBtn.style.borderColor = 'var(--text-color)';
        cancelBtn.style.color = 'var(--text-color)';
        cancelBtn.style.boxShadow = 'none';
    };
    disconnectButtons.appendChild(confirmBtn);
    disconnectButtons.appendChild(cancelBtn);
    disconnectModalContent.appendChild(disconnectTitle);
    disconnectModalContent.appendChild(disconnectMessage);
    disconnectModalContent.appendChild(disconnectButtons);
    disconnectModal.appendChild(disconnectModalContent);
    document.body.appendChild(disconnectModal);

    // 지갑 설치 안내 모달 생성
    const installModal = document.createElement('div');
    installModal.style.cssText = `
        display: none; position: fixed; z-index: 2002; left: 0; top: 0; width: 100%; height: 100%;
        overflow: auto; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center;
    `;
    const installModalContent = document.createElement('div');
    installModalContent.style.cssText = `
        background-color: var(--card-bg); padding: 30px; border: 2px solid var(--warning-color);
        border-radius: 15px; text-align: center; width: 90%; max-width: 450px;
        box-shadow: 0 0 30px rgba(255, 107, 53, 0.3);
    `;
    const installTitle = document.createElement('h3');
    installTitle.textContent = 'Wallet Not Found';
    installTitle.style.cssText = `
        font-family: 'Orbitron', sans-serif; color: var(--warning-color); 
        margin-bottom: 20px; font-size: 1.5em; text-transform: uppercase;
    `;
    const installMessage = document.createElement('p');
    installMessage.id = 'install-modal-message';
    installMessage.style.cssText = `
        color: var(--text-color); margin-bottom: 25px; font-size: 1.1em; line-height: 1.5;
    `;
    const installButtons = document.createElement('div');
    installButtons.style.cssText = `
        display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;
    `;
    const installBtn = document.createElement('button');
    installBtn.textContent = 'Install Wallet';
    installBtn.style.cssText = `
        padding: 12px 25px; background-color: var(--warning-color); color: var(--background-color);
        border: 2px solid var(--warning-color); border-radius: 5px; font-weight: 700;
        cursor: pointer; transition: all 0.3s; text-transform: uppercase;
    `;
    installBtn.onmouseover = () => {
        installBtn.style.boxShadow = '0 0 15px var(--warning-color)';
    };
    installBtn.onmouseout = () => {
        installBtn.style.boxShadow = 'none';
    };
    const closeInstallBtn = document.createElement('button');
    closeInstallBtn.textContent = 'Close';
    closeInstallBtn.style.cssText = `
        padding: 12px 25px; background-color: transparent; color: var(--text-color);
        border: 2px solid var(--text-color); border-radius: 5px; font-weight: 700;
        cursor: pointer; transition: all 0.3s; text-transform: uppercase;
    `;
    closeInstallBtn.onmouseover = () => {
        closeInstallBtn.style.borderColor = 'var(--warning-color)';
        closeInstallBtn.style.color = 'var(--warning-color)';
        closeInstallBtn.style.boxShadow = '0 0 15px var(--warning-color)';
    };
    closeInstallBtn.onmouseout = () => {
        closeInstallBtn.style.borderColor = 'var(--text-color)';
        closeInstallBtn.style.color = 'var(--text-color)';
        closeInstallBtn.style.boxShadow = 'none';
    };
    installButtons.appendChild(installBtn);
    installButtons.appendChild(closeInstallBtn);
    installModalContent.appendChild(installTitle);
    installModalContent.appendChild(installMessage);
    installModalContent.appendChild(installButtons);
    installModal.appendChild(installModalContent);
    document.body.appendChild(installModal);

    function getInstallUrl(walletId) {
        switch(walletId) {
            case 'phantom':
                return 'https://phantom.app/';
            case 'backpack':
                return 'https://backpack.app/';
            case 'solflare':
                return 'https://solflare.com/';
            default:
                return '';
        }
    }

    // Connect Wallet 버튼 클릭 시 모달 표시 (항상 동작)
    const connectBtn = document.getElementById('connect-wallet-btn');
    if (connectBtn && !connectBtn._walletEventRegistered) {
        connectBtn._walletEventRegistered = true;
        connectBtn.addEventListener('click', async (e) => {
            if (connectedWalletType) {
                disconnectModal.style.display = 'flex';
                confirmBtn.onclick = () => {
                    let provider = null;
                    if (connectedWalletType === 'phantom' && window.solana && window.solana.isPhantom) {
                        provider = window.solana;
                    } else if (connectedWalletType === 'backpack' && window.solana && window.solana.isBackpack) {
                        provider = window.solana;
                    } else if (connectedWalletType === 'solflare' && (window.solflare || (window.solana && window.solana.isSolflare))) {
                        provider = window.solflare || window.solana;
                    }
                    if (provider && provider.disconnect) {
                        provider.disconnect();
                    } else {
                        onDisconnect();
                    }
                    disconnectModal.style.display = 'none';
                };
                cancelBtn.onclick = () => {
                    disconnectModal.style.display = 'none';
                };
                return;
            }
            const isMobile = /Mobi|Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
            let provider = null;
            let walletType = null;
            if (isMobile) {
                if (window.solana && window.solana.isPhantom) {
                    provider = window.solana;
                    walletType = 'phantom';
                } else if (window.solana && window.solana.isBackpack) {
                    provider = window.solana;
                    walletType = 'backpack';
                } else if (window.solflare) {
                    provider = window.solflare;
                    walletType = 'solflare';
                }
                if (provider) {
                    try {
                        await provider.connect();
                        const address = provider.publicKey ? provider.publicKey.toString() : '';
                        connectedWalletType = walletType;
                        connectedAddress = address;
                        connectBtn.textContent = `Disconnect: ${address.slice(0,4)}...${address.slice(-4)}`;
                        document.getElementById('connect-wallet-section-horoscope').style.display = 'none';
                        document.getElementById('horoscope-result-section').style.display = '';
                        document.getElementById('loading-state-horoscope').style.display = 'none';
                        document.getElementById('error-state-horoscope').style.display = 'none';
                        showHoroscopeResult(address);
                        if (provider.on) {
                            provider.on('disconnect', onDisconnect);
                        }
                        return;
                    } catch (e) {
                        const messageElement = document.getElementById('install-modal-message');
                        if (messageElement) {
                            messageElement.textContent = 'Failed to connect wallet. Please try again in your wallet browser.';
                        }
                        installModal.style.display = 'flex';
                        return;
                    }
                }
            }
            while (modalContent.childNodes.length > 1) modalContent.removeChild(modalContent.lastChild);
            const wallets = [
                {
                    id: 'phantom',
                    name: 'Phantom',
                    logo: 'https://i.ibb.co/H5KnQH1/images.jpg',
                    deeplink: (url) => `phantom://app/ul/browse/${encodeURIComponent(url)}`
                },
                {
                    id: 'backpack',
                    name: 'Backpack',
                    logo: 'https://i.ibb.co/8nkGvqKT/33.jpg',
                    deeplink: (url) => `backpack://app/open?url=${encodeURIComponent(url)}`
                },
                {
                    id: 'solflare',
                    name: 'Solflare',
                    logo: 'https://i.ibb.co/WN5bgZMS/6839e3b263f212a02d7ee17d-Solflare-logo.png',
                    deeplink: (url) => `solflare://open?url=${encodeURIComponent(url)}`
                }
            ];
            wallets.forEach(wallet => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary wallet-select-btn';
                btn.style.cssText = 'display: flex; width: 100%; margin-bottom: 10px; align-items: center; justify-content: center;';
                btn.onclick = async () => {
                    if (isMobile) {
                        const deeplinkUrl = wallet.deeplink(window.location.href);
                        const installUrl = getInstallUrl(wallet.id);
                        const currentUrl = window.location.href;
                        window.location.href = deeplinkUrl;
                        setTimeout(() => {
                            if (window.location.href === currentUrl) {
                                const messageElement = document.getElementById('install-modal-message');
                                if (messageElement) {
                                    messageElement.textContent = `${wallet.name} wallet app is not installed on your mobile device. Please install the app and try again.`;
                                }
                                installBtn.onclick = () => {
                                    if (installUrl) {
                                        window.open(installUrl, '_blank');
                                    }
                                    installModal.style.display = 'none';
                                };
                                closeInstallBtn.onclick = () => {
                                    installModal.style.display = 'none';
                                };
                                installModal.style.display = 'flex';
                            }
                        }, 2000);
                        modal.style.display = 'none';
                        return;
                    }
                    let provider = null;
                    if (wallet.id === 'phantom' && window.solana && window.solana.isPhantom) {
                        provider = window.solana;
                        if (provider.isConnected && provider.disconnect) {
                            try { await provider.disconnect(); } catch (e) {}
                        }
                    } else if (wallet.id === 'backpack' && window.solana && window.solana.isBackpack) {
                        provider = window.solana;
                        if (provider.isConnected && provider.disconnect) {
                            try { await provider.disconnect(); } catch (e) {}
                        }
                    } else if (wallet.id === 'solflare' && (window.solflare || (window.solana && window.solana.isSolflare))) {
                        provider = window.solflare || window.solana;
                        if (provider.isConnected && provider.disconnect) {
                            try { await provider.disconnect(); } catch (e) {}
                        }
                    }
                    if (!provider) {
                        const messageElement = document.getElementById('install-modal-message');
                        if (messageElement) {
                            messageElement.textContent = `${wallet.name} wallet extension is not installed. Please install the extension and try again.`;
                        }
                        installBtn.onclick = () => {
                            const installUrl = getInstallUrl(wallet.id);
                            if (installUrl) {
                                window.open(installUrl, '_blank');
                            }
                            installModal.style.display = 'none';
                        };
                        closeInstallBtn.onclick = () => {
                            installModal.style.display = 'none';
                        };
                        installModal.style.display = 'flex';
                        return;
                    }
                    try {
                        await provider.connect();
                        if (provider.publicKey || (provider.publicKey && provider.publicKey.toString)) {
                            const address = provider.publicKey ? provider.publicKey.toString() : (provider.publicKey || '');
                            const shortAddr = address.slice(0, 4) + '...' + address.slice(-4);
                            connectedWalletType = wallet.id;
                            connectedAddress = address;
                            connectBtn.textContent = `Disconnect: ${shortAddr}`;
                            document.getElementById('connect-wallet-section-horoscope').style.display = 'none';
                            document.getElementById('horoscope-result-section').style.display = '';
                            document.getElementById('loading-state-horoscope').style.display = 'none';
                            document.getElementById('error-state-horoscope').style.display = 'none';
                            showHoroscopeResult(address);
                            if (provider.on) {
                                provider.on('disconnect', onDisconnect);
                            }
                        }
                        modal.style.display = 'none';
                    } catch (e) {
                        alert('Failed to connect wallet. Please check your wallet app or extension and try again.\n' + (e && e.message ? e.message : e));
                    }
                };
                const logo = document.createElement('img');
                logo.src = wallet.logo;
                logo.alt = wallet.name + ' Logo';
                logo.className = 'wallet-logo';
                btn.appendChild(logo);
                const span = document.createElement('span');
                span.textContent = `Connect ${wallet.name}`;
                btn.appendChild(span);
                modalContent.appendChild(btn);
            });
            modal.style.display = 'flex';
        });
    }
    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            modal.style.display = "none";
        }
        if (event.target === disconnectModal) {
            disconnectModal.style.display = "none";
        }
        if (event.target === installModal) {
            installModal.style.display = "none";
        }
    });

    function onDisconnect() {
        connectedWalletType = null;
        connectedAddress = null;
        connectBtn.textContent = 'Connect Wallet & See Fortune';
        document.getElementById('horoscope-result-section').style.display = 'none';
        document.getElementById('connect-wallet-section-horoscope').style.display = '';
    }
});

// 운세 결과 표시 함수
function showHoroscopeResult(address) {
    document.getElementById('fortune-state-horoscope').style.display = '';
    document.getElementById('wallet-address').textContent = address;
    const lastChar = address[address.length - 1];
    document.getElementById('fate-variable').textContent = lastChar;
    const simulationVariables = [
        "Quantum Fluctuation", "Cosmic Alignment", "Server Maintenance", "Random Number Surge", "Glitchy Matrix", "Mark's Mood", "Coffee Quality", "Buggy Patch", "AI Uprising", "Lucky Day"
    ];
    const reasons = [
        "Mark pulled an all-nighter.", "The simulation code was refactored.", "A cosmic ray hit the server.", "Mark's cat walked on the keyboard.", "The coffee was too strong.", "A bug was fixed (or introduced).", "Mark is feeling generous.", "The RNG gods smiled today.", "A new patch was deployed.", "Reality is unstable."
    ];
    const colors = ["Red", "Blue", "Green", "Yellow", "Purple", "Orange", "Pink", "Black", "White", "Cyan"];
    const places = ["Library", "Café", "Park", "Home", "Lab", "Gym", "Beach", "Mountain", "Museum", "Arcade"];
    const foods = ["Pizza", "Burger", "Sushi", "Ramen", "Salad", "Steak", "Ice Cream", "Taco", "Pasta", "Sandwich"];
    const seed = lastChar.charCodeAt(0);
    function pick(arr) { return arr[seed % arr.length]; }
    function randScore(offset) { return 40 + (seed * offset) % 60; }
    document.getElementById('simulation-variable').textContent = pick(simulationVariables);
    document.getElementById('reason').textContent = pick(reasons);
    const overall = randScore(1);
    const money = randScore(2);
    const love = randScore(3);
    const health = randScore(4);
    document.getElementById('overall-score').textContent = `${overall} / 100`;
    document.getElementById('money-score').textContent = `${money} / 100`;
    document.getElementById('love-score').textContent = `${love} / 100`;
    document.getElementById('health-score').textContent = `${health} / 100`;
    document.getElementById('overall-bar').style.width = `${overall}%`;
    document.getElementById('money-bar').style.width = `${money}%`;
    document.getElementById('love-bar').style.width = `${love}%`;
    document.getElementById('health-bar').style.width = `${health}%`;
    document.getElementById('overall-text').textContent = overall > 70 ? "Great day for simulation exploits!" : "Stay cautious, reality is unstable.";
    document.getElementById('money-text').textContent = money > 70 ? "Unexpected airdrop incoming?" : "Don't spend all your $MARK at once.";
    document.getElementById('love-text').textContent = love > 70 ? "NPCs are unusually friendly today." : "Maybe avoid romance subplots.";
    document.getElementById('health-text').textContent = health > 70 ? "System integrity: stable." : "Watch out for random bugs!";
    document.getElementById('rec-color').textContent = pick(colors);
    document.getElementById('rec-numbers').textContent = `${seed % 10}, ${(seed+3)%10}, ${(seed+7)%10}`;
    document.getElementById('rec-place').textContent = pick(places);
    document.getElementById('rec-food').textContent = pick(foods);
}
document.getElementById('back-to-main-btn').onclick = function() {
    window.location.href = 'index.html';
};
// === [MARK 토큰/지갑 변수 선언] ===
const MARK_MINT_ADDRESS = "MARK_MINT_ADDRESS"; // 실제 마크토큰 민트 주소로 교체
const PROJECT_WALLET_ADDRESS = "JBk9pkuDcwmJwz7TrfVSnitPGdLutWyRBMzTaLZNHhi3";
const MARK_DECIMALS = 9; // 실제 소수점 자리수로 교체(대부분 9)
// === 운세 부스트 함수 ===
async function boostHoroscopeUI() {
    // 각 점수 15% 증가 (최대 100)
    function boost(id) {
        const el = document.getElementById(id);
        let val = parseInt(el.textContent);
        val = Math.min(100, Math.round(val * 1.15));
        el.textContent = `${val} / 100`;
        document.getElementById(id.replace('-score', '-bar')).style.width = `${val}%`;
    }
    boost('overall-score');
    boost('money-score');
    boost('love-score');
    boost('health-score');
}
document.getElementById('boost-fortune-btn').onclick = async function() {
    const btn = this;
    const msg = document.getElementById('boost-message');
    if (!connectedWalletType || !connectedAddress) {
        msg.textContent = "먼저 지갑을 연결해주세요.";
        return;
    }
    btn.disabled = true;
    msg.textContent = "블록체인에 거래를 전송 중입니다...";
    try {
        const provider = window.solana || window.solflare;
        if (!provider) throw new Error("지갑이 감지되지 않았습니다.");
        const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'), 'confirmed');
        const fromPubkey = new solanaWeb3.PublicKey(connectedAddress);
        const toPubkey = new solanaWeb3.PublicKey(PROJECT_WALLET_ADDRESS);
        const mintPubkey = new solanaWeb3.PublicKey(MARK_MINT_ADDRESS);
        // Associated Token Account 찾기
        const fromTokenAccount = await solanaWeb3.Token.getAssociatedTokenAddress(
            solanaWeb3.ASSOCIATED_TOKEN_PROGRAM_ID,
            solanaWeb3.TOKEN_PROGRAM_ID,
            mintPubkey,
            fromPubkey
        );
        const toTokenAccount = await solanaWeb3.Token.getAssociatedTokenAddress(
            solanaWeb3.ASSOCIATED_TOKEN_PROGRAM_ID,
            solanaWeb3.TOKEN_PROGRAM_ID,
            mintPubkey,
            toPubkey
        );
        // 100 $MARK (소수점 반영)
        const amount = 100 * (10 ** MARK_DECIMALS);
        // 트랜잭션 생성
        const transaction = new solanaWeb3.Transaction().add(
            solanaWeb3.Token.createTransferInstruction(
                solanaWeb3.TOKEN_PROGRAM_ID,
                fromTokenAccount,
                toTokenAccount,
                fromPubkey,
                [],
                amount
            )
        );
        transaction.feePayer = fromPubkey;
        let { blockhash } = await connection.getRecentBlockhash();
        transaction.recentBlockhash = blockhash;
        // 지갑으로 서명 요청
        let signed = await provider.signTransaction(transaction);
        // 트랜잭션 전송
        let txid = await connection.sendRawTransaction(signed.serialize());
        msg.textContent = "거래 확인 중...";
        // 컨펌 대기
        await connection.confirmTransaction(txid, 'confirmed');
        // 운세 부스트
        boostHoroscopeUI();
        msg.textContent = "마크가 당신의 요청을 들었습니다! 운세가 상승했습니다.";
        btn.disabled = true;
        btn.textContent = "부스트 완료";
    } catch (e) {
        msg.textContent = "실패: " + (e.message || e);
        btn.disabled = false;
    }
};
    </script>
</body>
</html>