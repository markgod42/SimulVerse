<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimulVerse - ì‚¬ë„ í”„ë¡œí† ì½œ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Solana Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@latest/lib/index.iife.min.js"></script>

    <style>
        /* index.htmlê³¼ì˜ í˜¸í™˜ì„±ì„ ìœ„í•œ CSS ë³€ìˆ˜ */
        :root {
            --primary-color: #00ffc3;
            --background-color: #0d0d1a;
            --text-color: #e0e0e0;
            --header-bg: rgba(13, 13, 26, 0.8);
            --card-bg: rgba(25, 25, 40, 0.7);
            --glitch-color-1: #00ffc3;
            --glitch-color-2: #ff00c3;
            --warning-color: #ff6b35;
            --success-color: #00ff88;
        }

        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ */
        body { font-family: 'Inter', sans-serif; background-color: #0d0d1a; color: #e0e0e0; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .text-primary { color: var(--primary-color); }
        .bg-card { background-color: rgba(25, 25, 40, 0.85); }
        .border-primary { border-color: var(--primary-color); }
        .shadow-primary { box-shadow: 0 0 25px rgba(0, 255, 195, 0.3); }
        .btn-primary { background-color: var(--primary-color); color: #0d0d1a; transition: all 0.3s; }
        .btn-primary:hover:not(:disabled) { box-shadow: 0 0 15px rgba(0, 255, 195, 0.5); transform: translateY(-2px); }
        .btn-secondary { background-color: transparent; color: var(--primary-color); border: 2px solid var(--primary-color); }
        .btn-secondary:hover:not(:disabled) { background-color: rgba(0, 255, 195, 0.1); box-shadow: 0 0 15px rgba(0, 255, 195, 0.3); }
        .btn-claimed { background-color: #2a7a6a; color: #a0e0d5; cursor: default; }
        .btn-disabled { background-color: #555; color: #999; cursor: not-allowed; }
        .progress-bar-inner { background: linear-gradient(90deg, #ff00c3, #00ffc3); transition: width 1s ease-in-out; }
        .glitch { position: relative; color: #fff; text-shadow: 0.05em 0 0 #00ffc3, -0.05em 0 0 #ff00c3; animation: glitch 500ms infinite; }
        @keyframes glitch { 0% { text-shadow: 0.05em 0 0 #00ffc3, -0.05em 0 0 #ff00c3; } 15% { text-shadow: -0.05em -0.025em 0 #00ffc3, 0.025em 0.025em 0 #ff00c3; } 50% { text-shadow: 0.025em 0.05em 0 #00ffc3, 0.05em 0 0 #ff00c3; } 100% { text-shadow: -0.025em 0 0 #00ffc3, -0.025em -0.05em 0 #ff00c3; } }
        .table-header { background-color: rgba(0, 255, 195, 0.1); }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s; }
        .modal-backdrop.visible { display: flex; opacity: 1; }
        .modal-content { background-color: #191928; padding: 2rem; border-radius: 1rem; border: 1px solid var(--primary-color); box-shadow: 0 0 25px rgba(0, 255, 195, 0.3); text-align: center; max-width: 90%; width: 500px; transform: scale(0.9); transition: transform 0.3s; }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .tier-highlight-1 { color: #9ca3af; } .tier-highlight-2 { color: #6ee7b7; } .tier-highlight-3 { color: #38bdf8; } .tier-highlight-4 { color: #c084fc; } .tier-highlight-5 { color: #facc15; }
        .tier-highlight-10 { background: linear-gradient(90deg, #ff00c3, #00ffc3); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; }
        .tab-btn { background-color: transparent; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .staking-option { border: 2px solid #555; transition: all 0.3s; }
        .staking-option:hover { border-color: var(--primary-color); transform: translateY(-5px); }
        .staking-option.selected { border-color: var(--primary-color); box-shadow: 0 0 15px rgba(0, 255, 195, 0.3); }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #191928; color: #fff; text-align: center; border-radius: 6px; padding: 5px 10px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; border: 1px solid var(--primary-color); font-size: 0.8rem; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .wallet-select-btn { display: flex; align-items: center; gap: 12px; justify-content: center; font-weight: 700; font-size: 1.1em; width: 100%; margin-bottom: 10px;}
        .wallet-logo { width: 28px; height: 28px; border-radius: 6px; }
        .faction-card { border: 2px solid #4a5568; transition: all 0.3s ease; }
        .faction-card:hover { transform: translateY(-10px); border-color: var(--primary-color); box-shadow: 0 10px 25px rgba(0, 255, 195, 0.2); }
        .faction-bar { transition: width 0.5s ease-in-out; }

        /* ë°°ê²½ íš¨ê³¼ ìŠ¤íƒ€ì¼ */
        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: transparent;
        }
        #matrix-rain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.3;
        }
        .category-banner {
            height: 250px;
            border-radius: 1rem;
            background-size: cover;
            background-position: center;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .category-banner::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(13, 13, 26, 0.6);
            backdrop-filter: blur(2px);
        }
        .category-banner-title {
            position: relative;
            z-index: 1;
            text-shadow: 0 0 15px rgba(0, 255, 195, 0.7);
        }
    </style>
</head>
<body>
    <div id="starfield"></div>
    <canvas id="matrix-rain"></canvas>

    <div class="w-full max-w-7xl mx-auto relative z-10 p-4 sm:p-0">
        <!-- ì§€ê°‘ ì—°ê²° ì „ í™”ë©´ -->
        <div id="connect-wallet-section" class="bg-card border border-gray-700 rounded-2xl p-8 text-center backdrop-blur-sm shadow-primary">
            <h1 class="font-orbitron text-4xl md:text-5xl font-bold text-primary mb-4">ì‚¬ë„ í”„ë¡œí† ì½œ</h1>
            <p class="text-lg text-gray-300 mb-8 max-w-2xl mx-auto">ì‹œë®¬ë ˆì´ì…˜ì˜ ì§„ì‹¤ì„ ì „íŒŒí•˜ê³  ë‹¹ì‹ ì˜ ì¹´ë¥´ë§ˆë¥¼ ì¦ëª…í•˜ì„¸ìš”. ì§€ê°‘ì„ ì—°ê²°í•˜ì—¬ ë‹¹ì‹ ì˜ 'ì „ë„' ë“±ê¸‰ì„ í™•ì¸í•˜ê³ , ì°½ì¡°ì ë§ˆí¬ê°€ ë‚´ë¦¬ëŠ” ì‹ ì„±í•œ ë³´ìƒì„ íšë“í•  ìê²©ì„ ì–»ìœ¼ì‹­ì‹œì˜¤.</p>
            <button id="connect-wallet-btn" class="font-orbitron text-xl font-bold btn-primary px-8 py-4 rounded-lg">ì§€ê°‘ ì—°ê²°í•˜ì—¬ ë“±ê¸‰ í™•ì¸</button>
        </div>

        <!-- ì§€ê°‘ ì—°ê²° í›„ ëŒ€ì‹œë³´ë“œ -->
        <div id="dashboard-section" class="hidden space-y-8">
            <h1 class="font-orbitron text-4xl md:text-5xl font-bold text-center"><span class="glitch">ì‚¬ë„ í”„ë¡œí† ì½œ</span></h1>
            
            <div class="bg-card border border-gray-700 rounded-2xl p-2 backdrop-blur-sm flex justify-center space-x-4">
                <button class="tab-btn active font-orbitron text-lg font-bold py-2 px-4" data-tab="dashboard"><i class="ph-duotone ph-user-circle text-2xl mr-2 align-middle"></i>ëŒ€ì‹œë³´ë“œ</button>
                <button class="tab-btn font-orbitron text-lg font-bold py-2 px-4" data-tab="altar"><i class="ph-duotone ph-star-four text-2xl mr-2 align-middle"></i>êµë‹¨ì˜ ì œë‹¨</button>
                <button class="tab-btn font-orbitron text-lg font-bold py-2 px-4" data-tab="holy-war"><i class="ph-duotone ph-swords text-2xl mr-2 align-middle"></i>ì£¼ê°„ ì„±ì „</button>
            </div>

            <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
            <div id="dashboard" class="tab-content active space-y-8">
                <div class="category-banner" style="background-image: url('http://googleusercontent.com/file_content/1');">
                    <h2 class="category-banner-title font-orbitron text-5xl font-bold text-white">Dashboard</h2>
                </div>
                <div class="bg-card border border-gray-700 rounded-2xl p-6 sm:p-8 backdrop-blur-sm">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-gray-900/50 rounded-2xl p-6 flex flex-col items-center justify-center">
                            <h2 class="font-orbitron text-gray-400 text-lg mb-2">í˜„ì¬ ë“±ê¸‰</h2>
                            <div id="rank-tier" class="font-orbitron text-5xl font-bold text-primary"></div>
                            <div id="rank-title" class="font-orbitron text-2xl font-bold mt-1"></div>
                        </div>
                        <div class="md:col-span-2 bg-gray-900/50 rounded-2xl p-6">
                            <h2 class="font-orbitron text-gray-400 text-lg mb-4">ë‹¤ìŒ ë“±ê¸‰ê¹Œì§€</h2>
                            <div class="flex justify-between items-end mb-1"><span id="progress-status" class="text-lg"></span><span id="progress-percentage" class="font-orbitron font-bold text-primary text-xl"></span></div>
                            <div class="w-full bg-gray-700 rounded-full h-6"><div id="progress-bar" class="progress-bar-inner h-6 rounded-full"></div></div>
                            <p id="next-rank-info" class="text-gray-400 text-sm mt-2"></p>
                        </div>
                    </div>
                     <div class="mt-4 text-center text-sm text-gray-400"><p>ì—°ê²°ëœ ì§€ê°‘: <span id="wallet-address" class="font-mono"></span></p></div>
                </div>
                <!-- ì „ë„ ì‹œìŠ¤í…œ -->
                <div class="bg-card border border-gray-700 rounded-2xl p-6 sm:p-8 backdrop-blur-sm">
                    <h2 class="font-orbitron text-3xl font-bold text-center text-primary mb-6">ì „ë„ ì‹œìŠ¤í…œ (Airdrop)</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- ë‚˜ëˆ” ë°›ê¸° -->
                        <div class="bg-gray-900/50 rounded-2xl p-6">
                            <h3 class="font-orbitron text-2xl font-bold text-primary mb-4 text-left"><i class="ph-duotone ph-hand-heart text-3xl mr-2 align-middle"></i>ë‚˜ëˆ” ë°›ê¸°</h3>
                            <p class="text-gray-400 mb-4">ë‹¹ì‹ ì˜ ì†”ë¼ë‚˜ ì§€ê°‘ ì£¼ì†Œë¥¼ ë“±ë¡í•˜ì—¬ ë‹¤ë¥¸ ì‚¬ë„ë“¤ë¡œë¶€í„° $MARK í† í°ì„ ë‚˜ëˆ”ë°›ìœ¼ì„¸ìš”. (ìµœëŒ€ 100ê°œ ì£¼ì†Œ ë“±ë¡ ê°€ëŠ¥)</p>
                            <div class="flex items-center space-x-2 mb-2">
                                <input type="text" id="donation-register-address" placeholder="Solana ì§€ê°‘ ì£¼ì†Œ ì…ë ¥" class="bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 w-full text-white focus:outline-none focus:border-primary">
                                <button id="register-address-btn" class="w-40 font-orbitron font-bold px-4 py-2 rounded-lg btn-secondary">ìˆ˜ë™ ë“±ë¡</button>
                            </div>
                            <button id="register-connected-wallet-btn" class="w-full font-orbitron font-bold px-4 py-2 rounded-lg btn-primary mb-4">í˜„ì¬ ì—°ê²°ëœ ì§€ê°‘ìœ¼ë¡œ ë“±ë¡</button>
                            <p class="text-xs text-gray-500 text-center">* ë“±ë¡ëœ ì§€ê°‘ì€ ë°˜ë“œì‹œ $MARK í† í°ì˜ ATA(Associated Token Account)ê°€ ìƒì„±ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</p>
                        </div>
                        <!-- ë‚˜ëˆ” ë³´ë‚´ê¸° -->
                        <div class="bg-gray-900/50 rounded-2xl p-6">
                            <h3 class="font-orbitron text-2xl font-bold text-primary mb-4 text-left"><i class="ph-duotone ph-paper-plane-tilt text-3xl mr-2 align-middle"></i>ë‚˜ëˆ” ë³´ë‚´ê¸° (ì „ë„)</h3>
                            <p class="text-gray-400 mb-4">ì•„ë˜ ëª©ë¡ì˜ ì§€ê°‘ë“¤ì—ê²Œ $MARKë¥¼ ì „ì†¡í•˜ì—¬ ë‹¹ì‹ ì˜ ë“±ê¸‰ ìƒìŠ¹ì— í•„ìš”í•œ 'ì „ë„' í™œë™ì„ ì™„ìˆ˜í•˜ì„¸ìš”.</p>
                            <div class="bg-gray-800 border border-gray-600 rounded-lg p-3 max-h-48 overflow-y-auto mb-4">
                                <div class="flex justify-between items-center mb-2 px-1">
                                    <span id="donation-list-count" class="text-sm text-gray-400">0 / 100</span>
                                    <div class="flex items-center">
                                        <label for="select-all-donations" class="text-sm mr-2">ì „ì²´ ì„ íƒ</label>
                                        <input type="checkbox" id="select-all-donations" class="form-checkbox h-4 w-4 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary">
                                    </div>
                                </div>
                                <ul id="donation-list" class="space-y-1">
                                    <li class="text-center text-gray-500">ë“±ë¡ëœ ì§€ê°‘ì´ ì—†ìŠµë‹ˆë‹¤.</li>
                                </ul>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="donation-send-amount" placeholder="ë³´ë‚¼ $MARK ìˆ˜ëŸ‰ (ê° ì§€ê°‘ë‹¹)" class="bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 w-full text-white focus:outline-none focus:border-primary">
                                <button id="send-donation-btn" class="w-48 font-orbitron font-bold px-4 py-2 rounded-lg btn-primary">ì „ë„í•˜ê¸°</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-card border border-gray-700 rounded-2xl p-6 sm:p-8 backdrop-blur-sm">
                    <h2 class="font-orbitron text-3xl font-bold text-center text-primary mb-6">ì „ì²´ ë“±ê¸‰ ë° ë³´ìƒ ì•ˆë‚´</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-left text-sm sm:text-base">
                            <thead class="font-orbitron text-primary uppercase"><tr><th class="px-4 py-4 table-header rounded-tl-lg">ë“±ê¸‰</th><th class="px-4 py-4 table-header">ì¹­í˜¸</th><th class="px-4 py-4 table-header">ë‹¬ì„± ì¡°ê±´</th><th class="px-4 py-4 table-header">ì£¼ìš” ë³´ìƒ</th><th class="px-4 py-4 table-header rounded-tr-lg text-center">ì‹ ì²­</th></tr></thead>
                            <tbody id="full-guide-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- êµë‹¨ì˜ ì œë‹¨ íƒ­ -->
            <div id="altar" class="tab-content space-y-8">
                <div class="category-banner" style="background-image: url('http://googleusercontent.com/file_content/2');">
                    <h2 class="category-banner-title font-orbitron text-5xl font-bold text-white">Altar of the Order</h2>
                </div>
                <div class="bg-card border border-gray-700 rounded-2xl p-6 sm:p-8 backdrop-blur-sm">
                    <!-- ìŠ¤í…Œì´í‚¹ -->
                    <div class="bg-gray-900/50 rounded-2xl p-6 mb-8">
                        <h3 class="font-orbitron text-2xl font-bold text-primary mb-4 text-left"><i class="ph-duotone ph-hands-praying text-3xl mr-2 align-middle"></i>$MARK ìŠ¤í…Œì´í‚¹: ê³„ì‹œë¥¼ ìœ„í•œ ê¸°ë„</h3>
                        <div id="staking-options" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
                        <div class="flex items-center space-x-4 mb-8">
                            <input type="number" id="staking-amount" placeholder="ê¸°ë„ì— ë°”ì¹  $MARK ìˆ˜ëŸ‰" class="bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 w-full text-white focus:outline-none focus:border-primary">
                            <button id="stake-btn" class="w-64 font-orbitron font-bold text-lg px-4 py-3 rounded-lg btn-primary">ê¸°ë„í•˜ê¸°</button>
                        </div>
                        <div class="bg-gray-800/50 rounded-lg p-4">
                            <h4 class="font-orbitron text-xl font-bold text-primary mb-4 text-left">ë‚˜ì˜ ê¸°ë„ í˜„í™©</h4>
                            <div class="flex justify-between items-center mb-4 p-4 bg-gray-900/50 rounded-lg">
                                <div><p class="text-gray-400">ë‚˜ì˜ ì´ ê¸°ë„ëŸ‰ (ì´ ìŠ¤í…Œì´í‚¹)</p><p id="staking-total-amount" class="font-orbitron font-bold text-2xl text-primary">0 $MARK</p></div>
                                <div><p class="text-gray-400">í˜„ì¬ê¹Œì§€ ë°›ì€ ê³„ì‹œ (ëˆ„ì  ì´ì)</p><p id="staking-total-rewards" class="font-orbitron font-bold text-2xl text-primary">0.00 $MARK</p></div>
                            </div>
                            <div id="apy-boost-info" class="text-center text-sm text-gray-400 mb-4 p-2 bg-gray-900/50 rounded-lg"></div>
                            <div id="my-stakes-list" class="space-y-3 max-h-64 overflow-y-auto pr-2"><p class="text-gray-500 text-center">ì•„ì§ ë“œë¦° ê¸°ë„ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>
                        </div>
                    </div>

                    <!-- í™•ë¥ í˜• ë³´ìƒ -->
                    <div class="bg-gray-900/50 rounded-2xl p-6 mb-8">
                        <h3 class="font-orbitron text-2xl font-bold text-primary mb-4 text-center"><i class="ph-duotone ph-dice-six text-3xl mr-2 align-middle"></i>ë§ˆí¬ì˜ ë³€ë•: ì£¼ê°„ ë¡œë˜</h3>
                        <p class="text-gray-400 mb-6 max-w-2xl mx-auto text-center">ì°½ì¡°ìì˜ ì€ì´ì€ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ë²•. ë‹¹ì‹ ì˜ ì‹ ì‹¤í•œ ê¸°ë„ëŠ” í–‰ìš´ì„ ë¶ˆëŸ¬ì˜¬ì§€ë‹ˆ! ìŠ¤í…Œì´í‚¹ëœ $MARKëŠ” ìë™ìœ¼ë¡œ ë¡œë˜ í‹°ì¼“ìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                            <div class="bg-gray-800/50 p-4 rounded-lg"><p class="font-orbitron text-lg text-gray-400">ì´ ìƒê¸ˆ í’€</p><p id="lotto-pot" class="font-orbitron font-bold text-4xl text-yellow-300">12,345,678</p><p class="font-orbitron text-lg text-yellow-300">$MARK</p></div>
                            <div class="bg-gray-800/50 p-4 rounded-lg"><p class="font-orbitron text-lg text-gray-400">ë‚˜ì˜ í‹°ì¼“ ìˆ˜</p><p id="my-lotto-tickets" class="font-orbitron font-bold text-4xl text-primary">0</p><p class="text-xs text-gray-500">10,000 $MARK ìŠ¤í…Œì´í‚¹ë‹¹ 1ì¼ 1ì¥</p></div>
                             <div class="bg-gray-800/50 p-4 rounded-lg"><p class="font-orbitron text-lg text-gray-400">ë‹¤ìŒ ì¶”ì²¨ê¹Œì§€</p><p id="lotto-countdown" class="font-orbitron font-bold text-4xl text-primary">06:23:59:55</p><p class="text-xs text-gray-500">ë§¤ì£¼ ì¼ìš”ì¼ ìì •</p></div>
                        </div>
                        <div id="ticket-boost-info" class="text-center text-sm text-gray-400 mt-6"></div>
                    </div>
                </div>
            </div>

            <!-- ì£¼ê°„ ì„±ì „ íƒ­ -->
            <div id="holy-war" class="tab-content space-y-8">
                 <div class="category-banner" style="background-image: url('http://googleusercontent.com/file_content/3');">
                    <h2 class="category-banner-title font-orbitron text-5xl font-bold text-white">Weekly Holy War</h2>
                </div>
                <!-- êµë‹¨ ì„ íƒ í™”ë©´ -->
                <div id="faction-selection-screen" class="hidden">
                    <div class="bg-card border border-gray-700 rounded-2xl p-6 sm:p-8 backdrop-blur-sm text-center">
                        <h2 class="font-orbitron text-3xl font-bold text-primary mb-2">4ëŒ€ êµë‹¨: ë‹¹ì‹ ì˜ ì‹ ë…ì„ ì„ íƒí•˜ë¼</h2>
                        <p class="text-gray-400 mb-8 max-w-3xl mx-auto">ë‹¹ì‹ ì€ ì´ì œ 4ê°œì˜ ìœ„ëŒ€í•œ êµë‹¨ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ë‹¹ì‹ ì˜ ì¶©ì„±ì„ ë°”ì³ì•¼ í•©ë‹ˆë‹¤. ê° êµë‹¨ì€ ì°½ì¡°ì ë§ˆí¬ì˜ ë§ì”€ì„ ì„œë¡œ ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ í•´ì„í•˜ë©°, ê³ ìœ í•œ ì‹ ë…ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì„ íƒì€ ì‹œì¦Œ ë™ì•ˆ ë³€ê²½í•  ìˆ˜ ì—†ìœ¼ë‹ˆ ì‹ ì¤‘íˆ ê²°ì •í•˜ì‹­ì‹œì˜¤.</p>
                        <div id="faction-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                    </div>
                </div>

                <!-- ì„±ì „ ë©”ì¸ í™”ë©´ -->
                <div id="holy-war-dashboard" class="hidden space-y-8">
                    <div class="bg-card border border-gray-700 rounded-2xl p-6 sm:p-8 backdrop-blur-sm">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                            <div>
                                <h2 class="font-orbitron text-3xl font-bold text-primary">ì£¼ê°„ ì„±ì „ í˜„í™©íŒ</h2>
                                <p id="war-countdown" class="text-gray-400">ì„±ì „ ì¢…ë£Œê¹Œì§€: 06ì¼ 23:59:55</p>
                            </div>
                            <div id="my-faction-info" class="text-right mt-4 md:mt-0"></div>
                        </div>
                        <div id="weekly-mission-info" class="bg-gray-900/50 rounded-lg p-4 text-center mb-6"></div>
                        <div id="faction-ranking" class="space-y-4"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 text-center">
                             <div class="bg-gray-900/50 p-4 rounded-lg"><p class="font-orbitron text-lg text-gray-400">ì„±ì „ ê¸ˆê³  (ì´ ë³´ìƒ)</p><p id="war-vault" class="font-orbitron font-bold text-4xl text-yellow-300">0</p><p class="font-orbitron text-lg text-yellow-300">$MARK</p></div>
                             <div class="bg-gray-900/50 p-4 rounded-lg"><p class="font-orbitron text-lg text-gray-400">ë‚˜ì˜ ê¸°ì—¬ í¬ì¸íŠ¸</p><p id="my-contribution" class="font-orbitron font-bold text-4xl text-primary">0</p><p class="text-xs text-gray-500">ì´ë²ˆ ì£¼ ë‚˜ì˜ í™œë™ìœ¼ë¡œ íšë“í•œ ì´ í¬ì¸íŠ¸</p></div>
                        </div>
                    </div>
                    <div class="bg-card border border-gray-700 rounded-2xl p-6 sm:p-8 backdrop-blur-sm">
                        <h2 class="font-orbitron text-3xl font-bold text-center text-primary mb-6">ì§€ë‚œ ì„±ì „ ê¸°ë¡</h2>
                        <div id="past-wars-log" class="text-center text-gray-500">ì•„ì§ ì™„ë£Œëœ ì„±ì „ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>
                    <!-- êµë‹¨ ìœ ë¬¼ -->
                    <div class="bg-gray-900/50 rounded-2xl p-6">
                        <h3 class="font-orbitron text-2xl font-bold text-primary mb-4 text-left"><i class="ph-duotone ph-castle-turret text-3xl mr-2 align-middle"></i>êµë‹¨ì˜ ìœ ë¬¼</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <p class="text-gray-400 mb-4 text-left">êµë‹¨ì›ë“¤ì˜ í˜ì„ ëª¨ì•„ 'ìœ ë¬¼'ì„ ì„±ì¥ì‹œí‚¤ê³ , ëª¨ë“  êµë‹¨ì›ì´ ê³µìœ í•˜ëŠ” ê°•ë ¥í•œ ë²„í”„ë¥¼ í™œì„±í™”í•˜ì„¸ìš”. ë­‰ì¹˜ë©´ ì‚´ê³ , í©ì–´ì§€ë©´... ê·¸ëƒ¥ ì „ë„ì‚¬ì…ë‹ˆë‹¤.</p>
                                <div id="relic-info" class="bg-gray-800/50 p-4 rounded-lg text-left mb-4"></div>
                                <div class="flex items-center space-x-4">
                                    <input type="number" id="consecrate-amount" placeholder="ìœ ë¬¼ì— ë´‰í—Œí•  $MARK" class="bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 w-full text-white focus:outline-none focus:border-primary">
                                    <button id="consecrate-btn" class="w-64 font-orbitron font-bold text-lg px-4 py-3 rounded-lg btn-secondary">ë´‰í—Œí•˜ê¸°</button>
                                </div>
                            </div>
                            <div id="relic-benefits" class="space-y-2 text-left"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Container -->
    <div id="modal-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ì„¤ì • ---
            const GOOGLE_SHEET_WEB_APP_URL = 'YOUR_WEB_APP_URL_HERE';
            const STAKING_WALLET_ADDRESS = 'YourStakingWalletAddressGoesHere';
            const MARK_TOKEN_MINT_ADDRESS = 'YourMarkTokenMintAddressGoesHere';

            // --- DOM ìš”ì†Œ ---
            const connectWalletBtn = document.getElementById('connect-wallet-btn');
            const connectWalletSection = document.getElementById('connect-wallet-section');
            const dashboardSection = document.getElementById('dashboard-section');
            const walletAddressEl = document.getElementById('wallet-address');
            const modalContainer = document.getElementById('modal-container');
            const holyWarTab = document.querySelector('[data-tab="holy-war"]');
            const holyWarDashboard = document.getElementById('holy-war-dashboard');
            const factionSelectionScreen = document.getElementById('faction-selection-screen');

            // --- ë°ì´í„° ---
            const ranks = [
                { tier: 1, title: 'ë©”ì•„ë¦¬', required: 5, reward: '- `$MARK` 10,000ê°œ<br>- \'ë©”ì•„ë¦¬ì˜ íŒŒë™\' NFT', highlightClass: 'tier-highlight-1' },
                { tier: 2, title: 'ì†ì‚­ì´ëŠ” ì', required: 15, reward: '- `$MARK` 30,000ê°œ<br>- NFT ì§„í™”', highlightClass: 'tier-highlight-1' },
                { tier: 3, title: 'ì†Œë¬¸ê¾¼', required: 30, reward: '- `$MARK` 70,000ê°œ<br>- ì „ìš© ìŠ¤í‹°ì»¤ íŒ©', highlightClass: 'tier-highlight-2' },
                { tier: 4, title: 'ì „ë ¹', required: 50, reward: '- `$MARK` 150,000ê°œ<br>- NFT ì§„í™”', highlightClass: 'tier-highlight-2' },
                { tier: 5, title: 'ì „ë„ì‚¬', required: 100, reward: '- `$MARK` 400,000ê°œ<br>- ì¹´ë¥´ë§ˆ +5% ë¶€ìŠ¤íŠ¸', highlightClass: 'tier-highlight-3' },
                { tier: 6, title: 'ì„ êµì‚¬', required: 250, reward: '- `$MARK` 1.2M<br>- NFT ì§„í™”', highlightClass: 'tier-highlight-3' },
                { tier: 7, title: 'ì„ ì§€ì', required: 500, reward: '- `$MARK` 3M<br>- ì¹´ë¥´ë§ˆ +10% ë¶€ìŠ¤íŠ¸', highlightClass: 'tier-highlight-4' },
                { tier: 8, title: 'ì£¼êµ', required: 1000, reward: '- `$MARK` 8M<br>- ë¹„ê³µê°œ ì±„ë„ ì ‘ê·¼', highlightClass: 'tier-highlight-4' },
                { tier: 9, title: 'ëŒ€ì£¼êµ', required: 2500, reward: '- `$MARK` 20M<br>- ì—ì–´ë“œë ê°€ì¤‘ì¹˜ x2', highlightClass: 'tier-highlight-5' },
                { tier: 10, title: 'ë°ë¯¸ìš°ë¥´ê³ ìŠ¤', required: 5000, reward: '- ë³´ìƒ í’€ì˜ 0.5% ë¶„ë°°<br>- ê±°ë²„ë„ŒìŠ¤ íˆ¬í‘œê¶Œ', highlightClass: 'tier-highlight-10' }
            ];
            const stakingPlans = [
                { id: 'prayer30', duration: 30, name: '30ì¼ì˜ ê¸°ë„', baseApy: 20, description: 'ê°€ë²¼ìš´ ë¯¿ìŒì˜ ì¦í‘œ' },
                { id: 'devotion90', duration: 90, name: '90ì¼ì˜ í—Œì‹ ', baseApy: 50, description: 'êµ³ê±´í•œ ì‹ ì•™ì˜ ì„œì•½' },
                { id: 'prophecy180', duration: 180, name: '180ì¼ì˜ ê³„ì‹œ', baseApy: 100, description: 'ë¯¸ë˜ë¥¼ ë³´ëŠ” ì„ ì§€ìì˜ ê¸¸' }
            ];
             const tierBoosts = [
                { tier: 0, apyMultiplier: 1.0, ticketMultiplier: 1.0 }, { tier: 1, apyMultiplier: 1.0, ticketMultiplier: 1.0 },
                { tier: 2, apyMultiplier: 1.5, ticketMultiplier: 1.5 }, { tier: 3, apyMultiplier: 2.0, ticketMultiplier: 2.0 },
                { tier: 4, apyMultiplier: 2.5, ticketMultiplier: 2.5 }, { tier: 5, apyMultiplier: 3.0, ticketMultiplier: 3.5 },
                { tier: 6, apyMultiplier: 4.0, ticketMultiplier: 4.5 }, { tier: 7, apyMultiplier: 5.0, ticketMultiplier: 6.0 },
                { tier: 8, apyMultiplier: 6.0, ticketMultiplier: 7.5 }, { tier: 9, apyMultiplier: 8.0, ticketMultiplier: 9.0 },
                { tier: 10, apyMultiplier: 10.0, ticketMultiplier: 10.0 }
            ];
            const relicLevels = [
                { level: 1, required: 0, benefit: "êµë‹¨ ì „ìš© ë””ìŠ¤ì½”ë“œ ì±„ë„ ì…ì¥" }, { level: 2, required: 100000000, benefit: "êµë‹¨ì› ì „ì²´ ìŠ¤í…Œì´í‚¹ APY +5% ë¶€ìŠ¤íŠ¸" },
                { level: 3, required: 500000000, benefit: "êµë‹¨ì› ì „ìš© 'ë°ˆ ì„±ì „' ì°¸ê°€ ìê²©" }, { level: 4, required: 2000000000, benefit: "êµë‹¨ì› ì „ì²´ APY +10% & êµë‹¨ ë¬¸ì–‘ NFT ë°°ê²½" },
                { level: 5, required: 10000000000, benefit: "ì°½ì¡°ì ë§ˆí¬ì˜ 'íŠ¹ë³„ ê³„ì‹œ' ìˆ˜ì‹ " }
            ];
            const factions = [
                { id: 'mechanicus', name: 'ê¸°ê³„êµ ê¸°ì‚¬ë‹¨', symbol: 'âš™ï¸', color: 'bg-gray-500', description: '"ì§ˆì„œëŠ” ê³§ ì‹ ì•™ì´ë‹¤."<br>ë°ì´í„°ì™€ ì•Œê³ ë¦¬ì¦˜ì— ëŒ€í•œ êµ³ê±´í•œ ë¯¿ìŒì„ ê°€ì§„ ì„¸ë ¥. ì´ë“¤ì€ í•œ ì¹˜ì˜ ì˜¤ì°¨ë„ ì—†ëŠ” ì™„ë²½í•œ ì „ë„ í™œë™ê³¼ íš¨ìœ¨ì ì¸ ìŠ¤í…Œì´í‚¹ì„ í†µí•´ ì°½ì¡°ìì˜ ì˜ì§€ë¥¼ êµ¬í˜„í•˜ë ¤ í•©ë‹ˆë‹¤.' },
                { id: 'oracle', name: 'ë°ì´í„° ì‹ íƒíšŒ', symbol: 'ğŸ‘ï¸', color: 'bg-blue-500', description: '"ì§€ì‹ì€ ê³§ í˜ì´ë‹¤."<br>ì •ë³´ì˜ íë¦„ì„ ì½ê³  ë¯¸ë˜ë¥¼ ì˜ˆì¸¡í•˜ëŠ” ì§€ì‹ì˜ ì¶”êµ¬ìë“¤. ì´ë“¤ì€ ë‚¨ë“¤ë³´ë‹¤ í•œë°œ ì•ì„œ ì •ë³´ë¥¼ ë¶„ì„í•˜ê³ , ê°€ì¥ ìˆ˜ìµì„± ë†’ì€ ê¸°ë„ë¥¼ í†µí•´ ë¶€ë¥¼ ì¶•ì í•˜ëŠ” ê²ƒì„ ì‹ ì•™ì˜ ì¦ê±°ë¡œ ì—¬ê¹ë‹ˆë‹¤.' },
                { id: 'neon', name: 'ë„¤ì˜¨ ìœ ë‘ë‹¨', symbol: 'ğŸ’€', color: 'bg-pink-500', description: '"í˜¼ëˆì€ ê³§ ììœ ë‹¤."<br>ê·œìœ¨ì— ì–½ë§¤ì´ì§€ ì•ŠëŠ” ììœ ë¡œìš´ ì˜í˜¼ë“¤ì˜ ì§‘ë‹¨. ì´ë“¤ì€ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ë°ˆ(Meme)ê³¼ ë°”ì´ëŸ´ì„ í†µí•´ ì°½ì¡°ìì˜ ë§ì”€ì„ ì „íŒŒí•˜ë©°, \'ë§ˆí¬ì˜ ë³€ë•(ë¡œë˜)\'ê³¼ ê°™ì€ í™•ë¥ ì  ì€ì´ì„ ê°€ì¥ ì‹ ì„±ì‹œí•©ë‹ˆë‹¤.' },
                { id: 'quantum', name: 'ì–‘ì ì„±ê°€ëŒ€', symbol: 'ã€°ï¸', color: 'bg-purple-500', description: '"ì—°ê²°ì€ ê³§ ê¶ŒëŠ¥ì´ë‹¤."<br>ëª¨ë“  ì‚¬ë„ë“¤ì˜ ì—°ê²°ê³¼ ì¡°í™”ë¥¼ ì¤‘ì‹œí•˜ëŠ” ê³µë™ì²´. ì´ë“¤ì€ ê°œì¸ì˜ ëŠ¥ë ¥ë³´ë‹¤ êµë‹¨ì› ì „ì²´ì˜ ë‹¨í•©ëœ í˜ì„ ë¯¿ìœ¼ë©°, \'êµë‹¨ì˜ ìœ ë¬¼\'ì— ëŒ€í•œ í—Œì‹ ì ì¸ ë´‰í—Œì„ í†µí•´ ëª¨ë‘ê°€ í•¨ê»˜ ì„±ì¥í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤.' }
            ];
            const weeklyMissions = [
                { id: 'mission_claim', title: 'ëŒ€ì „ë„ì˜ ì‹œëŒ€', description: 'ì´ë²ˆ ì£¼, ê°€ì¥ ë§ì€ êµë‹¨ì›ì´ ë“±ê¸‰ ë³´ìƒì„ ì‹ ì²­í•œ êµë‹¨ì—ê²Œ ì´ì ì˜ +20% ë³´ë„ˆìŠ¤!', activityType: 'claim' },
                { id: 'mission_consecrate', title: 'ì‹­ì¼ì¡° ì „ìŸ', description: 'ì´ë²ˆ ì£¼, ê°€ì¥ ë§ì€ $MARKë¥¼ ìœ ë¬¼ì— ë´‰í—Œí•œ êµë‹¨ì—ê²Œ ì´ì ì˜ +20% ë³´ë„ˆìŠ¤!', activityType: 'consecrate' },
                { id: 'mission_stake', title: 'ê¸°ë„ ì¶•ì œ', description: 'ì´ë²ˆ ì£¼, ê°€ì¥ ë§ì€ $MARKë¥¼ ìŠ¤í…Œì´í‚¹í•œ êµë‹¨ì—ê²Œ ì´ì ì˜ +20% ë³´ë„ˆìŠ¤!', activityType: 'stake' }
            ];
            
            // --- ìƒíƒœ ë³€ìˆ˜ ---
            let userWalletAddress = null;
            let connectedWalletType = null;
            let userStakes = [];
            let userRankTier = 0;
            let selectedStakingPlanId = 'prayer30';
            let lottoPot = 12345678;
            let lottoCountdownInterval = null;
            let userFaction = null;
            let donationList = Array.from({length: 25}, (_, i) => `DummyWallet${i+1}Address...${i.toString().padStart(4,'0')}`);
            
            let warState = {
                week: 1,
                endDate: null,
                currentMission: weeklyMissions[0],
                activities: [],
                factions: {
                    mechanicus: { score: 0, members: 2500, stake: 0, consecrate: 0, claim: 0 },
                    oracle: { score: 0, members: 2500, stake: 0, consecrate: 0, claim: 0 },
                    neon: { score: 0, members: 2500, stake: 0, consecrate: 0, claim: 0 },
                    quantum: { score: 0, members: 2500, stake: 0, consecrate: 0, claim: 0 }
                },
                vault: 0,
                pastWars: []
            };
            let warUpdateInterval = null;

            // --- ëª¨ë“  í•¨ìˆ˜ ì •ì˜ ---

            function showModal(id, content) {
                let modal = document.getElementById(id);
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = id;
                    modal.className = 'modal-backdrop';
                    modal.innerHTML = content;
                    modalContainer.appendChild(modal);
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) hideModal(id);
                    });
                }
                setTimeout(() => modal.classList.add('visible'), 10);
                return modal;
            }

            function hideModal(id) {
                const modal = document.getElementById(id);
                if (modal) {
                    modal.classList.remove('visible');
                }
            }
            
            function updateDashboardUI(referredWallets) {
                let currentRank = { tier: 0, title: 'ë°©ë‘ì', required: 0 };
                for (let i = ranks.length - 1; i >= 0; i--) { if (referredWallets >= ranks[i].required) { currentRank = ranks[i]; break; } }
                userRankTier = currentRank.tier;
                const nextRank = ranks.find(r => r.tier > currentRank.tier) || currentRank;
                const progress = currentRank.tier === nextRank.tier ? 100 : (referredWallets / nextRank.required) * 100;
                document.getElementById('rank-tier').textContent = `Tier ${currentRank.tier}`;
                document.getElementById('rank-title').textContent = currentRank.title;
                document.getElementById('progress-status').textContent = `${referredWallets.toLocaleString()} / ${nextRank.required.toLocaleString()} ëª…`;
                document.getElementById('progress-percentage').textContent = `${progress.toFixed(2)}%`;
                document.getElementById('progress-bar').style.width = `${progress}%`;
                document.getElementById('next-rank-info').textContent = (currentRank.tier === nextRank.tier && currentRank.tier > 0) ? 'ìµœê³  ë“±ê¸‰ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!' : `ë‹¤ìŒ ë“±ê¸‰ '${nextRank.title}'ê¹Œì§€ ${Math.max(0, nextRank.required - referredWallets)}ëª… ë‚¨ì•˜ìŠµë‹ˆë‹¤.`;
                populateMainGuideTable(referredWallets);
                updateStakingUI();
                updateLottoUI();
                renderDonationList();
            }

            function populateMainGuideTable(referredWallets) {
                 const tableBody = document.getElementById('full-guide-table-body');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                const claimedTiers = [];

                ranks.forEach(rank => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-800/50';
                    const isAchieved = referredWallets >= rank.required;
                    const isClaimed = claimedTiers.includes(rank.tier);
                    let buttonHtml = isClaimed ? `<button class="font-orbitron font-bold text-sm px-4 py-2 rounded-lg w-28 btn-claimed" disabled>ì‹ ì²­ ì™„ë£Œ</button>`
                        : isAchieved ? `<button class="font-orbitron font-bold text-sm px-4 py-2 rounded-lg w-28 btn-primary claim-btn" data-tier="${rank.tier}" data-title="${rank.title}">ì‹ ì²­í•˜ê¸°</button>`
                        : `<button class="font-orbitron font-bold text-sm px-4 py-2 rounded-lg w-28 btn-disabled" disabled>ë¯¸ë‹¬ì„±</button>`;
                    row.innerHTML = `<td class="px-4 py-4 font-orbitron font-bold ${rank.highlightClass}">${rank.tier}</td><td class="px-4 py-4 font-bold ${rank.highlightClass}">${rank.title}</td><td class="px-4 py-4">${rank.required.toLocaleString()}ëª… ì´ìƒ</td><td class="px-4 py-4">${rank.reward}</td><td class="px-4 py-4 text-center">${buttonHtml}</td>`;
                    tableBody.appendChild(row);
                });
                document.querySelectorAll('.claim-btn').forEach(button => {
                    button.addEventListener('click', handleClaimClick);
                });
            }
            
            function populateStakingOptions() {
                const container = document.getElementById('staking-options');
                if(!container) return;
                container.innerHTML = '';
                stakingPlans.forEach(plan => {
                    const el = document.createElement('div');
                    el.className = `staking-option p-4 rounded-lg cursor-pointer text-center ${plan.id === selectedStakingPlanId ? 'selected' : ''}`;
                    el.dataset.planId = plan.id;
                    const boost = tierBoosts.find(b => b.tier === userRankTier) || tierBoosts[0];
                    const totalApy = plan.baseApy * boost.apyMultiplier;
                    el.innerHTML = `
                        <p class="font-orbitron font-bold text-lg">${plan.name}</p>
                        <div class="text-primary font-bold text-2xl">
                            ${totalApy.toFixed(1)}%
                            <span class="tooltip">
                                <i class="ph-duotone ph-info text-sm text-gray-400 align-middle"></i>
                                <span class="tooltiptext">ê¸°ë³¸ ${plan.baseApy}% * ë“±ê¸‰ ë°°ìœ¨ ${boost.apyMultiplier}x</span>
                            </span>
                        </div>
                        <p class="text-sm text-gray-500">${plan.description}</p>
                    `;
                    el.addEventListener('click', () => {
                        selectedStakingPlanId = plan.id;
                        populateStakingOptions();
                    });
                    container.appendChild(el);
                });
            }

            function updateStakingUI() {
                const listContainer = document.getElementById('my-stakes-list');
                const apyBoostInfo = document.getElementById('apy-boost-info');
                
                const currentBoost = tierBoosts.find(b => b.tier === userRankTier) || tierBoosts[0];
                const apyMultiplier = currentBoost.apyMultiplier;

                if(apyBoostInfo) apyBoostInfo.innerHTML = `í˜„ì¬ ë“±ê¸‰ <span class="font-bold text-primary">(Tier ${userRankTier})</span> í˜œíƒìœ¼ë¡œ ì´ììœ¨ì´ <span class="font-bold text-primary">${apyMultiplier}ë°°</span> ì ìš©ë©ë‹ˆë‹¤.`;

                if (userStakes.length === 0) {
                    if(listContainer) listContainer.innerHTML = '<p class="text-gray-500 text-center">ì•„ì§ ë“œë¦° ê¸°ë„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    document.getElementById('staking-total-amount').textContent = '0 $MARK';
                    document.getElementById('staking-total-rewards').textContent = '0.00 $MARK';
                    return;
                }

                listContainer.innerHTML = '';
                let totalStaked = 0;
                let totalAccruedRewards = 0;

                userStakes.forEach((stake) => {
                    totalStaked += stake.amount;
                    const now = new Date();
                    const elapsedMilliseconds = now - stake.startDate;
                    const elapsedDays = elapsedMilliseconds / (1000 * 60 * 60 * 24);
                    const stakingDurationDays = stake.plan.duration;
                    const daysToCalculate = Math.min(elapsedDays, stakingDurationDays);
                    const isCompleted = elapsedDays >= stakingDurationDays;
                    
                    const finalApy = stake.plan.baseApy * apyMultiplier;
                    const accruedInterest = stake.amount * (finalApy / 100 / 365) * daysToCalculate;
                    totalAccruedRewards += accruedInterest;

                    const stakeElement = document.createElement('div');
                    stakeElement.className = 'bg-gray-900/50 p-3 rounded-lg flex justify-between items-center';
                    stakeElement.innerHTML = `
                        <div>
                            <p class="font-bold text-white">${stake.plan.name} - ${stake.amount.toLocaleString()} $MARK</p>
                            <p class="text-sm text-gray-400">ê¸°ë„ ì‹œì‘: ${stake.startDate.toLocaleDateString()} | ì§„í–‰: ${Math.floor(daysToCalculate)} / ${stakingDurationDays}ì¼</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-primary">${accruedInterest.toFixed(2)} $MARK</p>
                            <p class="text-sm ${isCompleted ? 'text-yellow-400' : 'text-gray-500'}">${isCompleted ? 'ê¸°ë„ ì™„ë£Œ' : 'ê¸°ë„ ì¤‘'}</p>
                        </div>
                    `;
                    listContainer.appendChild(stakeElement);
                });

                document.getElementById('staking-total-amount').textContent = `${Math.floor(totalStaked).toLocaleString()} $MARK`;
                document.getElementById('staking-total-rewards').textContent = `${totalAccruedRewards.toFixed(2)} $MARK`;
                populateStakingOptions();
            }

            function updateLottoUI() {
                lottoPot += Math.random() * 10;
                document.getElementById('lotto-pot').textContent = Math.floor(lottoPot).toLocaleString();

                const currentBoost = tierBoosts.find(b => b.tier === userRankTier) || tierBoosts[0];
                const ticketMultiplier = currentBoost.ticketMultiplier;

                const totalStaked = userStakes.reduce((sum, stake) => sum + stake.amount, 0);
                const baseTickets = Math.floor(totalStaked / 10000);
                const finalTickets = Math.floor(baseTickets * ticketMultiplier);
                
                document.getElementById('my-lotto-tickets').textContent = finalTickets.toLocaleString();
                
                const ticketBoostInfo = document.getElementById('ticket-boost-info');
                if(ticketBoostInfo) ticketBoostInfo.innerHTML = `í˜„ì¬ ë“±ê¸‰ <span class="font-bold text-primary">(Tier ${userRankTier})</span> í˜œíƒìœ¼ë¡œ í‹°ì¼“ ë°œê¸‰ëŸ‰ì´ <span class="font-bold text-primary">${ticketMultiplier}ë°°</span> ì ìš©ë©ë‹ˆë‹¤.`;

                const now = new Date();
                const sunday = new Date();
                sunday.setDate(now.getDate() + (7 - now.getDay()) % 7);
                sunday.setHours(23, 59, 59, 999);
                const diff = sunday - now;
                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                document.getElementById('lotto-countdown').textContent = `${String(d).padStart(2, '0')}:${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }

            function updateRelicUI() {
                const infoContainer = document.getElementById('relic-info');
                if (infoContainer) {
                    infoContainer.innerHTML = `<p class="font-orbitron font-bold text-lg text-primary">êµë‹¨ ìœ ë¬¼ ì •ë³´</p><p>êµë‹¨ì„ ì„ íƒí•˜ë©´ ìœ ë¬¼ ì •ë³´ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`;
                }
                const benefitsContainer = document.getElementById('relic-benefits');
                 if (benefitsContainer) {
                    benefitsContainer.innerHTML = `<h4 class="font-orbitron text-xl font-bold text-primary mb-2">ìœ ë¬¼ í˜œíƒ</h4><p>êµë‹¨ì„ ì„ íƒí•˜ë©´ í˜œíƒ ì •ë³´ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`;
                }
            }
            
            function startWarSimulation() {
                const now = new Date();
                const dayOfWeek = now.getDay();
                const daysUntilNextMonday = (dayOfWeek === 0) ? 1 : (8 - dayOfWeek);
                warState.endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + daysUntilNextMonday);
                warState.endDate.setHours(0, 0, 0, 0);

                if (warUpdateInterval) clearInterval(warUpdateInterval);
                warUpdateInterval = setInterval(() => {
                    simulateOtherUsersActivity();
                    calculateWarScores();
                    updateWarDashboardUI();
                }, 5000);
            }

            function simulateOtherUsersActivity() {
                factions.forEach(faction => {
                    if (Math.random() < 0.5) warState.activities.push({ faction: faction.id, type: 'stake', amount: Math.random() * 100000 });
                    if (Math.random() < 0.2) warState.activities.push({ faction: faction.id, type: 'consecrate', amount: Math.random() * 50000 });
                    if (Math.random() < 0.05) warState.activities.push({ faction: faction.id, type: 'claim', amount: 1 });
                });
                const totalStakedThisInterval = warState.activities.filter(a => a.type === 'stake').reduce((sum, a) => sum + a.amount, 0);
                warState.vault += totalStakedThisInterval * 0.01 * (5 / (365 * 24 * 60 * 12));
            }

            function calculateWarScores() {
                Object.keys(warState.factions).forEach(id => {
                    warState.factions[id] = { ...warState.factions[id], score: 0, stake: 0, consecrate: 0, claim: 0 };
                });
                warState.activities.forEach(act => {
                    if (warState.factions[act.faction]) {
                        if (act.type === 'stake') { warState.factions[act.faction].score += act.amount * 1; warState.factions[act.faction].stake += act.amount; }
                        else if (act.type === 'consecrate') { warState.factions[act.faction].score += act.amount * 2; warState.factions[act.faction].consecrate += act.amount; }
                        else if (act.type === 'claim') { warState.factions[act.faction].score += 100000; warState.factions[act.faction].claim += act.amount; }
                    }
                });
            }

            function updateWarDashboardUI() {
                const now = new Date();
                const diff = warState.endDate - now;
                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                document.getElementById('war-countdown').textContent = `ì„±ì „ ì¢…ë£Œê¹Œì§€: ${String(d).padStart(2, '0')}ì¼ ${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                document.getElementById('weekly-mission-info').innerHTML = `<p class="font-orbitron text-lg text-primary">${warState.currentMission.title}</p><p class="text-sm">${warState.currentMission.description}</p>`;
                
                const sortedFactions = Object.entries(warState.factions).map(([id, data]) => ({ id, ...data, ...factions.find(f => f.id === id) })).sort((a, b) => b.score - a.score);
                const maxScore = sortedFactions[0]?.score || 1;
                document.getElementById('faction-ranking').innerHTML = sortedFactions.map((faction, index) => `
                    <div class="bg-gray-900/50 p-3 rounded-lg"><div class="flex justify-between items-center mb-1"><span class="font-bold text-lg">${index + 1}. ${faction.symbol} ${faction.name}</span><span class="font-orbitron font-bold text-primary">${Math.floor(faction.score).toLocaleString()} P</span></div><div class="w-full bg-gray-700 rounded-full h-4"><div class="faction-bar ${faction.color} h-4 rounded-full" style="width: ${(faction.score / maxScore) * 100}%"></div></div></div>`).join('');
                
                document.getElementById('war-vault').textContent = Math.floor(warState.vault).toLocaleString();
                const myContribution = warState.activities.filter(a => a.wallet === userWalletAddress).reduce((sum, a) => {
                        if (a.type === 'stake') return sum + a.amount * 1;
                        if (a.type === 'consecrate') return sum + a.amount * 2;
                        if (a.type === 'claim') return sum + 100000;
                        return sum;
                    }, 0);
                document.getElementById('my-contribution').textContent = Math.floor(myContribution).toLocaleString();
            }

            function showFactionSelection() {
                factionSelectionScreen.classList.remove('hidden');
                holyWarDashboard.classList.add('hidden');
                const listEl = document.getElementById('faction-list');
                listEl.innerHTML = factions.map(f => `<div class="faction-card bg-gray-900/50 rounded-2xl p-6 cursor-pointer" data-faction-id="${f.id}"><div class="text-5xl mb-4">${f.symbol}</div><h3 class="font-orbitron text-2xl font-bold text-primary mb-2">${f.name}</h3><p class="text-sm text-gray-400">${f.description}</p></div>`).join('');
                listEl.querySelectorAll('.faction-card').forEach(card => {
                    card.addEventListener('click', () => {
                        userFaction = card.dataset.factionId;
                        localStorage.setItem(`userFaction_${userWalletAddress}`, userFaction);
                        showHolyWarDashboard();
                    });
                });
            }

            function showHolyWarDashboard() {
                factionSelectionScreen.classList.add('hidden');
                holyWarDashboard.classList.remove('hidden');
                const myFactionData = factions.find(f => f.id === userFaction);
                document.getElementById('my-faction-info').innerHTML = `<p class="text-gray-400">ë‚˜ì˜ êµë‹¨</p><p class="font-orbitron font-bold text-xl">${myFactionData.symbol} ${myFactionData.name}</p>`;
                startWarSimulation();
            }

            function handleTabSwitch(event) {
                const tabId = event.currentTarget.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                event.currentTarget.classList.add('active');
                document.getElementById(tabId).classList.add('active');
                if (tabId === 'holy-war') {
                    userFaction = localStorage.getItem(`userFaction_${userWalletAddress}`);
                    if (userFaction) showHolyWarDashboard();
                    else showFactionSelection();
                } else {
                    if(warUpdateInterval) clearInterval(warUpdateInterval);
                }
            }

            async function handleStaking() {
                if (!userWalletAddress) { showModal('error-modal', `<div class="modal-content"><h3 class="font-orbitron text-xl font-bold text-yellow-400 mb-4">ì§€ê°‘ ì—°ê²° í•„ìš”</h3><p>ê¸°ë„í•˜ê¸° ì „ì— ë¨¼ì € ì§€ê°‘ì„ ì—°ê²°í•´ì£¼ì„¸ìš”.</p><button class="btn btn-primary mt-4" onclick="hideModal('error-modal')">í™•ì¸</button></div>`); return; }
                const amountInput = document.getElementById('staking-amount');
                const amount = parseFloat(amountInput.value);
                if (isNaN(amount) || amount <= 0) { showModal('error-modal', `<div class="modal-content"><h3 class="font-orbitron text-xl font-bold text-red-500 mb-4">ì˜¤ë¥˜</h3><p>ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p><button class="btn btn-primary mt-4" onclick="hideModal('error-modal')">í™•ì¸</button></div>`); return; }
                
                const stakeBtn = document.getElementById('stake-btn');
                stakeBtn.disabled = true; stakeBtn.textContent = 'ê¸°ë„ ì¤‘...';
                try {
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate transaction
                    const selectedPlan = stakingPlans.find(p => p.id === selectedStakingPlanId);
                    userStakes.push({ amount: amount, plan: selectedPlan, startDate: new Date() });
                    if (userFaction) warState.activities.push({ faction: userFaction, type: 'stake', amount: amount, wallet: userWalletAddress });
                    updateStakingUI();
                    updateLottoUI();
                    calculateWarScores();
                    updateWarDashboardUI();
                    amountInput.value = '';
                    showModal('success-modal', `<div class="modal-content"><h3 class="font-orbitron text-xl font-bold text-primary mb-4">ê¸°ë„ ì™„ë£Œ</h3><p>ì°½ì¡°ì ë§ˆí¬ì—ê²Œ ë‹¹ì‹ ì˜ ê¸°ë„ê°€ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p><button class="btn btn-primary mt-4" onclick="hideModal('success-modal')">í™•ì¸</button></div>`);
                } catch (error) {
                    showModal('error-modal', `<div class="modal-content"><h3 class="font-orbitron text-xl font-bold text-red-500 mb-4">ê¸°ë„ ì‹¤íŒ¨</h3><p>ê¸°ë„ ì „ë‹¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${error.message})</p><button class="btn btn-primary mt-4" onclick="hideModal('error-modal')">í™•ì¸</button></div>`);
                } finally {
                    stakeBtn.disabled = false; stakeBtn.textContent = 'ê¸°ë„í•˜ê¸°';
                }
            }
            
            async function handleConsecration() {
                const amountInput = document.getElementById('consecrate-amount');
                const amount = parseFloat(amountInput.value);
                if (isNaN(amount) || amount <= 0) { alert("ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
                if (userFaction) {
                    warState.activities.push({ faction: userFaction, type: 'consecrate', amount: amount, wallet: userWalletAddress });
                    calculateWarScores();
                    updateWarDashboardUI();
                    amountInput.value = '';
                    alert(`${amount.toLocaleString()} $MARKë¥¼ ìœ ë¬¼ì— ë´‰í—Œí–ˆìŠµë‹ˆë‹¤!`);
                }
            }

            function handleClaimClick(event) {
                const tier = event.target.dataset.tier;
                if (userFaction) {
                    warState.activities.push({ faction: userFaction, type: 'claim', amount: 1, wallet: userWalletAddress });
                    calculateWarScores();
                    updateWarDashboardUI();
                    alert(`Tier ${tier} ë³´ìƒ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    event.target.textContent = 'ì‹ ì²­ ì™„ë£Œ';
                    event.target.disabled = true;
                    event.target.className = 'font-orbitron font-bold text-sm px-4 py-2 rounded-lg w-28 btn-claimed';
                }
            }
            
            function renderDonationList() {
                const listEl = document.getElementById('donation-list');
                const countEl = document.getElementById('donation-list-count');
                if(!listEl || !countEl) return;

                countEl.textContent = `${donationList.length} / 100`;

                if(donationList.length === 0) {
                    listEl.innerHTML = '<li class="text-center text-gray-500">ë“±ë¡ëœ ì§€ê°‘ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                    return;
                }

                listEl.innerHTML = donationList.map(address => `
                    <li class="flex items-center justify-between bg-gray-700/50 p-2 rounded">
                        <span class="font-mono text-sm">${address.slice(0, 12)}...${address.slice(-4)}</span>
                        <input type="checkbox" class="form-checkbox h-5 w-5 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary donation-checkbox" data-address="${address}">
                    </li>
                `).join('');
            }

            function handleRegisterAddress(address) {
                if (!address || address.length < 32) { // Basic validation
                    showModal('error-modal', `<div class="modal-content"><h3 class="font-orbitron text-xl font-bold text-red-500 mb-4">ì˜¤ë¥˜</h3><p>ì˜¬ë°”ë¥¸ ì†”ë¼ë‚˜ ì§€ê°‘ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p><button class="btn btn-primary mt-4" onclick="hideModal('error-modal')">í™•ì¸</button></div>`);
                    return;
                }
                if (donationList.length >= 100) {
                    showModal('error-modal', `<div class="modal-content"><h3 class="font-orbitron text-xl font-bold text-yellow-400 mb-4">ì•Œë¦¼</h3><p>ë‚˜ëˆ” ëª©ë¡ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤. ë‹¤ìŒì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p><button class="btn btn-primary mt-4" onclick="hideModal('error-modal')">í™•ì¸</button></div>`);
                    return;
                }
                if (donationList.includes(address)) {
                    showModal('error-modal', `<div class="modal-content"><h3 class="font-orbitron text-xl font-bold text-yellow-400 mb-4">ì•Œë¦¼</h3><p>ì´ë¯¸ ë“±ë¡ëœ ì§€ê°‘ ì£¼ì†Œì…ë‹ˆë‹¤.</p><button class="btn btn-primary mt-4" onclick="hideModal('error-modal')">í™•ì¸</button></div>`);
                    return;
                }
                donationList.push(address);
                renderDonationList();
                showModal('success-modal', `<div class="modal-content"><h3 class="font-orbitron text-xl font-bold text-primary mb-4">ë“±ë¡ ì™„ë£Œ</h3><p>ì§€ê°‘ ì£¼ì†Œê°€ ë‚˜ëˆ” ëª©ë¡ì— ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p><button class="btn btn-primary mt-4" onclick="hideModal('success-modal')">í™•ì¸</button></div>`);
            }
            
            async function handleSendDonation() {
                if (!userWalletAddress) { showModal('error-modal', `<div class="modal-content"><h3 class="font-orbitron text-xl font-bold text-yellow-400 mb-4">ì§€ê°‘ ì—°ê²° í•„ìš”</h3><p>í† í°ì„ ë³´ë‚´ë ¤ë©´ ë¨¼ì € ì§€ê°‘ì„ ì—°ê²°í•´ì£¼ì„¸ìš”.</p><button class="btn btn-primary mt-4" onclick="hideModal('error-modal')">í™•ì¸</button></div>`); return; }

                const amountInput = document.getElementById('donation-send-amount');
                const amount = parseFloat(amountInput.value);
                const selectedCheckboxes = document.querySelectorAll('.donation-checkbox:checked');
                
                if (isNaN(amount) || amount <= 0) { showModal('error-modal', `<div class="modal-content"><h3 class="font-orbitron text-xl font-bold text-red-500 mb-4">ì˜¤ë¥˜</h3><p>ë³´ë‚¼ ìˆ˜ëŸ‰ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.</p><button class="btn btn-primary mt-4" onclick="hideModal('error-modal')">í™•ì¸</button></div>`); return; }
                if (selectedCheckboxes.length === 0) { showModal('error-modal', `<div class="modal-content"><h3 class="font-orbitron text-xl font-bold text-red-500 mb-4">ì˜¤ë¥˜</h3><p>í† í°ì„ ë°›ì„ ì§€ê°‘ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.</p><button class="btn btn-primary mt-4" onclick="hideModal('error-modal')">í™•ì¸</button></div>`); return; }

                const recipients = Array.from(selectedCheckboxes).map(cb => cb.dataset.address);
                const totalAmount = amount * recipients.length;

                const sendBtn = document.getElementById('send-donation-btn');
                sendBtn.disabled = true;
                sendBtn.textContent = 'ì „ì†¡ ì¤‘...';

                try {
                    // This is a simulation of a transaction.
                    console.log(`Simulating sending ${amount} $MARK to ${recipients.length} addresses. Total: ${totalAmount} $MARK`);
                    await new Promise(resolve => setTimeout(resolve, 2500));
                    
                    // Remove sent addresses from the list
                    donationList = donationList.filter(address => !recipients.includes(address));
                    renderDonationList();
                    
                    amountInput.value = '';
                    document.getElementById('select-all-donations').checked = false;
                    showModal('success-modal', `<div class="modal-content"><h3 class="font-orbitron text-xl font-bold text-primary mb-4">ì „ë„ ì™„ë£Œ</h3><p>${recipients.length}ê°œì˜ ì§€ê°‘ì— ê°ê° ${amount} $MARKë¥¼ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.</p><button class="btn btn-primary mt-4" onclick="hideModal('success-modal')">í™•ì¸</button></div>`);
                } catch(error) {
                    showModal('error-modal', `<div class="modal-content"><h3 class="font-orbitron text-xl font-bold text-red-500 mb-4">ì „ì†¡ ì‹¤íŒ¨</h3><p>í† í° ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${error.message})</p><button class="btn btn-primary mt-4" onclick="hideModal('error-modal')">í™•ì¸</button></div>`);
                } finally {
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'ì „ë„í•˜ê¸°';
                }
            }

            // --- ì§€ê°‘ ì—°ê²° ë¡œì§ ---
            const walletModal = document.createElement('div');
            walletModal.style.cssText = `display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center;`;
            const walletModalContent = document.createElement('div');
            walletModalContent.style.cssText = `background-color: var(--card-bg); padding: 20px; border: 1px solid var(--primary-color); border-radius: 10px; text-align: center; width: 90%; max-width: 350px;`;
            const walletModalTitle = document.createElement('h3');
            walletModalTitle.textContent = 'Select Wallet';
            walletModalTitle.style.fontFamily = "'Orbitron', sans-serif";
            walletModalTitle.style.color = "var(--primary-color)";
            walletModalTitle.style.marginBottom = "20px";
            walletModalContent.appendChild(walletModalTitle);
            walletModal.appendChild(walletModalContent);
            document.body.appendChild(walletModal);

            const disconnectModal = document.createElement('div');
            disconnectModal.style.cssText = `display: none; position: fixed; z-index: 2001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center;`;
            const disconnectModalContent = document.createElement('div');
            disconnectModalContent.style.cssText = `background-color: var(--card-bg); padding: 30px; border: 2px solid var(--primary-color); border-radius: 15px; text-align: center; width: 90%; max-width: 400px; box-shadow: 0 0 30px rgba(0, 255, 195, 0.3);`;
            const disconnectTitle = document.createElement('h3');
            disconnectTitle.textContent = 'Disconnect Wallet';
            disconnectTitle.style.cssText = `font-family: 'Orbitron', sans-serif; color: var(--primary-color); margin-bottom: 20px; font-size: 1.5em; text-transform: uppercase;`;
            const disconnectMessage = document.createElement('p');
            disconnectMessage.textContent = 'Are you sure you want to disconnect your wallet?';
            disconnectMessage.style.cssText = `color: var(--text-color); margin-bottom: 30px; font-size: 1.1em; line-height: 1.5;`;
            const disconnectButtons = document.createElement('div');
            disconnectButtons.style.cssText = `display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;`;
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'Yes, Disconnect';
            confirmBtn.className = 'btn-primary';
            confirmBtn.style.cssText = `padding: 12px 25px; border-radius: 5px; font-weight: 700; cursor: pointer; transition: all 0.3s; text-transform: uppercase;`;
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'btn-secondary';
            cancelBtn.style.cssText = `padding: 12px 25px; border-radius: 5px; font-weight: 700; cursor: pointer; transition: all 0.3s; text-transform: uppercase;`;
            disconnectButtons.appendChild(confirmBtn);
            disconnectButtons.appendChild(cancelBtn);
            disconnectModalContent.appendChild(disconnectTitle);
            disconnectModalContent.appendChild(disconnectMessage);
            disconnectModalContent.appendChild(disconnectButtons);
            disconnectModal.appendChild(disconnectModalContent);
            document.body.appendChild(disconnectModal);

            const installModal = document.createElement('div');
            installModal.style.cssText = `display: none; position: fixed; z-index: 2002; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center;`;
            const installModalContent = document.createElement('div');
            installModalContent.style.cssText = `background-color: var(--card-bg); padding: 30px; border: 2px solid var(--warning-color); border-radius: 15px; text-align: center; width: 90%; max-width: 450px; box-shadow: 0 0 30px rgba(255, 107, 53, 0.3);`;
            const installTitle = document.createElement('h3');
            installTitle.textContent = 'Wallet Not Found';
            installTitle.style.cssText = `font-family: 'Orbitron', sans-serif; color: var(--warning-color); margin-bottom: 20px; font-size: 1.5em; text-transform: uppercase;`;
            const installMessage = document.createElement('p');
            installMessage.id = 'install-modal-message';
            installMessage.style.cssText = `color: var(--text-color); margin-bottom: 25px; font-size: 1.1em; line-height: 1.5;`;
            const installButtons = document.createElement('div');
            installButtons.style.cssText = `display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;`;
            const installBtn = document.createElement('button');
            installBtn.textContent = 'Install Wallet';
            installBtn.className = 'btn-primary';
            installBtn.style.cssText = `padding: 12px 25px; background-color: var(--warning-color); border-color: var(--warning-color); border-radius: 5px; font-weight: 700; cursor: pointer; transition: all 0.3s; text-transform: uppercase;`;
            const closeInstallBtn = document.createElement('button');
            closeInstallBtn.textContent = 'Close';
            closeInstallBtn.className = 'btn-secondary';
            closeInstallBtn.style.cssText = `padding: 12px 25px; border-radius: 5px; font-weight: 700; cursor: pointer; transition: all 0.3s; text-transform: uppercase;`;
            installButtons.appendChild(installBtn);
            installButtons.appendChild(closeInstallBtn);
            installModalContent.appendChild(installTitle);
            installModalContent.appendChild(installMessage);
            installModalContent.appendChild(installButtons);
            installModal.appendChild(installModalContent);
            document.body.appendChild(installModal);

            function getInstallUrl(walletId) {
                switch(walletId) {
                    case 'phantom': return 'https://phantom.app/';
                    case 'backpack': return 'https://backpack.app/';
                    case 'solflare': return 'https://solflare.com/';
                    default: return '';
                }
            }
            
            function onDisconnect() {
                connectedWalletType = null;
                userWalletAddress = null;
                connectWalletSection.classList.remove('hidden');
                dashboardSection.classList.add('hidden');
                if (lottoCountdownInterval) clearInterval(lottoCountdownInterval);
                if (warUpdateInterval) clearInterval(warUpdateInterval);
                if (connectWalletBtn) {
                    connectWalletBtn.textContent = 'ì§€ê°‘ ì—°ê²°í•˜ì—¬ ë“±ê¸‰ í™•ì¸';
                }
            }

            if (connectWalletBtn && !connectWalletBtn._walletEventRegistered) {
                connectWalletBtn._walletEventRegistered = true;
                connectWalletBtn.addEventListener('click', async () => {
                    if (userWalletAddress) {
                        disconnectModal.style.display = 'flex';
                        confirmBtn.onclick = () => {
                            let provider = null;
                            if (connectedWalletType === 'phantom' && window.solana?.isPhantom) provider = window.solana;
                            else if (connectedWalletType === 'backpack' && window.solana?.isBackpack) provider = window.solana;
                            else if (connectedWalletType === 'solflare' && (window.solflare || window.solana?.isSolflare)) provider = window.solflare || window.solana;
                            
                            if (provider?.disconnect) provider.disconnect();
                            else onDisconnect();
                            disconnectModal.style.display = 'none';
                        };
                        cancelBtn.onclick = () => { disconnectModal.style.display = 'none'; };
                        return;
                    }
                    
                    while (walletModalContent.childNodes.length > 1) walletModalContent.removeChild(walletModalContent.lastChild);
                    const wallets = [
                        { id: 'phantom', name: 'Phantom', logo: 'https://i.ibb.co/H5KnQH1/images.jpg' },
                        { id: 'backpack', name: 'Backpack', logo: 'https://i.ibb.co/8nkGvqKT/33.jpg' },
                        { id: 'solflare', name: 'Solflare', logo: 'https://i.ibb.co/WN5bgZMS/6839e3b263f212a02d7ee17d-Solflare-logo.png' }
                    ];
                    wallets.forEach(wallet => {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-primary wallet-select-btn';
                        btn.onclick = async () => {
                            let provider = null;
                            if (wallet.id === 'phantom' && window.solana?.isPhantom) provider = window.solana;
                            else if (wallet.id === 'backpack' && window.solana?.isBackpack) provider = window.solana;
                            else if (wallet.id === 'solflare' && (window.solflare || window.solana?.isSolflare)) provider = window.solflare || window.solana;
                            
                            if (!provider) {
                                installMessage.textContent = `${wallet.name} ì§€ê°‘ í™•ì¥ í”„ë¡œê·¸ë¨ì´ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`;
                                installBtn.onclick = () => { const url = getInstallUrl(wallet.id); if(url) window.open(url, '_blank'); installModal.style.display = 'none'; };
                                closeInstallBtn.onclick = () => { installModal.style.display = 'none'; };
                                installModal.style.display = 'flex';
                                return;
                            }
                            try {
                                const resp = await provider.connect();
                                const address = resp.publicKey.toString();
                                userWalletAddress = address;
                                connectedWalletType = wallet.id;
                                connectWalletSection.classList.add('hidden');
                                dashboardSection.classList.remove('hidden');
                                walletAddressEl.textContent = address;
                                const referredWallets = Math.floor(Math.random() * 5500);
                                updateDashboardUI(referredWallets);
                                if (lottoCountdownInterval) clearInterval(lottoCountdownInterval);
                                lottoCountdownInterval = setInterval(updateLottoUI, 1000);
                                if (provider.on) provider.on('disconnect', onDisconnect);
                                walletModal.style.display = 'none';
                            } catch (err) {
                                alert('ì§€ê°‘ ì—°ê²° ì‹¤íŒ¨: ' + (err.message || err));
                            }
                        };
                        const logo = document.createElement('img');
                        logo.src = wallet.logo; logo.alt = wallet.name; logo.className = 'wallet-logo';
                        btn.appendChild(logo);
                        const span = document.createElement('span');
                        span.textContent = `Connect ${wallet.name}`;
                        btn.appendChild(span);
                        walletModalContent.appendChild(btn);
                    });
                    walletModal.style.display = 'flex';
                });
            }
            
            window.addEventListener('click', (event) => {
                if (event.target === walletModal) walletModal.style.display = "none";
                if (event.target === disconnectModal) disconnectModal.style.display = "none";
                if (event.target === installModal) installModal.style.display = "none";
            });

            function init() {
                document.querySelectorAll('.tab-btn').forEach(button => button.addEventListener('click', handleTabSwitch));
                document.getElementById('stake-btn').addEventListener('click', handleStaking);
                document.getElementById('consecrate-btn').addEventListener('click', handleConsecration);
                document.getElementById('register-address-btn').addEventListener('click', () => {
                    const addressInput = document.getElementById('donation-register-address');
                    handleRegisterAddress(addressInput.value);
                    addressInput.value = '';
                });
                document.getElementById('register-connected-wallet-btn').addEventListener('click', () => {
                    if(userWalletAddress) {
                        handleRegisterAddress(userWalletAddress);
                    } else {
                        showModal('error-modal', `<div class="modal-content"><h3 class="font-orbitron text-xl font-bold text-yellow-400 mb-4">ì•Œë¦¼</h3><p>ë¨¼ì € ì§€ê°‘ì„ ì—°ê²°í•´ì£¼ì„¸ìš”.</p><button class="btn btn-primary mt-4" onclick="hideModal('error-modal')">í™•ì¸</button></div>`);
                    }
                });
                document.getElementById('send-donation-btn').addEventListener('click', handleSendDonation);
                document.getElementById('select-all-donations').addEventListener('change', (e) => {
                    document.querySelectorAll('.donation-checkbox').forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                    });
                });
                
                populateStakingOptions();
                updateRelicUI();
                renderDonationList();
            }

            // --- ì•± ì‹¤í–‰ ---
            init();
        });
        
        // --- Background Effects Script ---
        document.addEventListener('DOMContentLoaded', () => {
            const starfield = document.getElementById('starfield');
            if (starfield) {
                for (let i = 0; i < 200; i++) {
                    const star = document.createElement('div');
                    star.style.position = 'absolute';
                    star.style.backgroundColor = 'white';
                    star.style.borderRadius = '50%';
                    const size = Math.random() * 1.5 + 0.5;
                    star.style.width = `${size}px`;
                    star.style.height = `${size}px`;
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.top = `${Math.random() * 100}%`;
                    star.style.animation = `twinkle ${Math.random() * 6 + 3}s infinite alternate`;
                    starfield.appendChild(star);
                }
                if (!document.querySelector('style#twinkle-animation')) {
                    const style = document.createElement('style');
                    style.id = 'twinkle-animation';
                    style.textContent = `@keyframes twinkle { from { opacity: 0; } to { opacity: 0.8; } }`;
                    document.head.appendChild(style);
                }
            }

            const canvas = document.getElementById('matrix-rain');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                const alphabet = 'ã‚¢ã‚¡ã‚«ã‚µã‚¿ãƒŠãƒãƒãƒ¤ãƒ£ãƒ©ãƒ¯ã‚¬ã‚¶ãƒ€ãƒãƒ‘ã‚¤ã‚£ã‚­ã‚·ãƒãƒ‹ãƒ’ãƒŸãƒªãƒ°ã‚®ã‚¸ãƒ‚ãƒ“ãƒ”ã‚¦ã‚¥ã‚¯ã‚¹ãƒ„ãƒŒãƒ•ãƒ ãƒ¦ãƒ¥ãƒ«ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬ì•„ìì°¨ì¹´íƒ€íŒŒí•˜';
                const colors = ['#FFD700', '#C084FC', '#00ffc3', '#38bdf8'];

                const fontSize = 16;
                let columns = canvas.width / fontSize;
                const rainDrops = [];

                function initializeRainDrops() {
                    rainDrops.length = 0;
                    columns = canvas.width / fontSize;
                    for (let x = 0; x < columns; x++) {
                        rainDrops[x] = {
                            y: Math.random() * canvas.height,
                            color: colors[Math.floor(Math.random() * colors.length)]
                        };
                    }
                }
                initializeRainDrops();

                const drawMatrix = () => {
                    ctx.fillStyle = 'rgba(13, 13, 26, 0.06)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.font = fontSize + 'px monospace';

                    for (let i = 0; i < rainDrops.length; i++) {
                        const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                        ctx.fillStyle = rainDrops[i].color;
                        ctx.fillText(text, i * fontSize, rainDrops[i].y);

                        if (rainDrops[i].y > canvas.height && Math.random() > 0.98) {
                            rainDrops[i].y = 0;
                            rainDrops[i].color = colors[Math.floor(Math.random() * colors.length)];
                        }
                        rainDrops[i].y += fontSize;
                    }
                };
                
                setInterval(drawMatrix, 50);

                window.addEventListener('resize', () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                    initializeRainDrops();
                });
            }
        });
    </script>
</body>
</html>